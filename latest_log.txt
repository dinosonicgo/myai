### AI Lover Log - Last updated at 2025-09-23T23:01:17.021782 ###

2025-09-23 22:07:18 - [WARNING] - [512280345618546699] Key #4 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.45 秒後進行第 3 次嘗試...
2025-09-23 22:07:20 - [ERROR] - [512280345618546699] Key #4 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:07:30 - [WARNING] - [512280345618546699] Key #5 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.45 秒後進行第 2 次嘗試...
2025-09-23 22:07:32 - [WARNING] - [512280345618546699] Key #5 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.15 秒後進行第 3 次嘗試...
2025-09-23 22:07:34 - [ERROR] - [512280345618546699] Key #5 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:07:42 - [WARNING] - [512280345618546699] Key #0 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.24 秒後進行第 2 次嘗試...
2025-09-23 22:07:45 - [WARNING] - [512280345618546699] Key #0 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.15 秒後進行第 3 次嘗試...
2025-09-23 22:07:47 - [ERROR] - [512280345618546699] Key #0 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:07:50 - [WARNING] - [512280345618546699] Key #1 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.29 秒後進行第 2 次嘗試...
2025-09-23 22:07:52 - [WARNING] - [512280345618546699] Key #1 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.13 秒後進行第 3 次嘗試...
2025-09-23 22:07:55 - [ERROR] - [512280345618546699] Key #1 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:07:55 - [WARNING] - [512280345618546699] Key #2 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.46 秒後進行第 2 次嘗試...
2025-09-23 22:07:57 - [WARNING] - [512280345618546699] Key #2 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.32 秒後進行第 3 次嘗試...
2025-09-23 22:08:00 - [ERROR] - [512280345618546699] Key #2 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:08:00 - [WARNING] - [512280345618546699] Key #3 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.42 秒後進行第 2 次嘗試...
2025-09-23 22:08:02 - [WARNING] - [512280345618546699] Key #3 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.16 秒後進行第 3 次嘗試...
2025-09-23 22:08:04 - [ERROR] - [512280345618546699] Key #3 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰。
2025-09-23 22:08:04 - [WARNING] - [512280345618546699] [Model Degradation] 模型 'gemini-2.5-pro' 的所有金鑰均嘗試失敗。正在降級到下一個模型...
2025-09-23 22:08:14 - [INFO] - [512280345618546699] [生成即摘要] 雙重輸出解析成功。
2025-09-23 22:08:14 - [INFO] - [512280345618546699] 回應已發送。正在啟動事後處理任務...
2025-09-23 22:08:19 - [INFO] - [512280345618546699] [事後處理-LORE保險] 獨立的背景LORE提取器已啟動...
2025-09-23 22:08:19 - [ERROR] - [512280345618546699] [事後處理-LORE保險] 背景LORE提取與擴展任務執行時發生未預期的異常: 'AILover' object has no attribute 'get_lore_extraction_chain'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 620, in _background_lore_extraction
    prompt_template = self.get_lore_extraction_chain()
AttributeError: 'AILover' object has no attribute 'get_lore_extraction_chain'. Did you mean: 'lore_extraction_chain'?
2025-09-23 22:13:04 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:13:04 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:13:05 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:13:05 - [INFO] - Discord Bot is ready!
2025-09-23 22:13:07 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:13:07 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:13:08 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:23:18 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 22:23:18 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 22:23:18 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 22:23:18 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 1 條文檔用於構建 BM25。
2025-09-23 22:23:18 - [INFO] - [512280345618546699] (Retriever Builder) 純 BM25 檢索器構建成功。
2025-09-23 22:23:18 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-23 22:23:18 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-23 22:23:18 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-23 22:23:18 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 3 條訊息。
2025-09-23 22:23:32 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['response_style_prompt']
2025-09-23 22:23:33 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 22:23:40 - [INFO] - [512280345618546699] 啟動「生成即摘要」對話流程...
2025-09-23 22:23:40 - [INFO] - [512280345618546699] [預處理-生成即摘要] 正在準備上下文...
2025-09-23 22:23:40 - [INFO] - [512280345618546699] [導演視角] 當前錨定模式: 'local'
2025-09-23 22:23:40 - [INFO] - [512280345618546699] [導演視角] 檢測到本地互動指令，視角保持 'local'。
2025-09-23 22:23:40 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-23 22:23:40 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 22:23:40 - [INFO] - [512280345618546699] 正在組合混合記憶...
2025-09-23 22:23:40 - [INFO] - [512280345618546699] (RAG Cache) 檢索到 1 份文檔，正在檢查淨化快取...
2025-09-23 22:23:40 - [WARNING] - [512280345618546699] (RAG Sanitizer) 所有檢索到的文檔都未能成功淨化。
2025-09-23 22:23:40 - [INFO] - [512280345618546699] [生成即摘要] 正在執行雙重輸出生成...
2025-09-23 22:23:40 - [ERROR] - 處理使用者 512280345618546699 的「生成即摘要」流程時發生異常: AILover._get_next_available_key() takes 1 positional argument but 2 were given
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1073, in on_message
    final_response, summary_data = await ai_instance.preprocess_and_generate(input_data)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1955, in preprocess_and_generate
    raw_dual_output = await self.ainvoke_with_rotation(full_prompt, retry_strategy='force', use_degradation=True)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 358, in ainvoke_with_rotation
    key_info = self._get_next_available_key(model_name)
TypeError: AILover._get_next_available_key() takes 1 positional argument but 2 were given
2025-09-23 22:27:17 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:27:17 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:27:18 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:27:18 - [INFO] - Discord Bot is ready!
2025-09-23 22:27:20 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:27:20 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:27:21 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:27:22 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 1 條文檔用於構建 BM25。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] (Retriever Builder) 純 BM25 檢索器構建成功。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-23 22:27:22 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 3 條訊息。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 啟動「生成即摘要」對話流程...
2025-09-23 22:27:22 - [INFO] - [512280345618546699] [預處理-生成即摘要] 正在準備上下文...
2025-09-23 22:27:22 - [INFO] - [512280345618546699] [導演視角] 當前錨定模式: 'local'
2025-09-23 22:27:22 - [INFO] - [512280345618546699] [導演視角] 檢測到本地互動指令，視角保持 'local'。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-23 22:27:22 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] 正在組合混合記憶...
2025-09-23 22:27:22 - [INFO] - [512280345618546699] (RAG Cache) 檢索到 1 份文檔，正在檢查淨化快取...
2025-09-23 22:27:22 - [WARNING] - [512280345618546699] (RAG Sanitizer) 所有檢索到的文檔都未能成功淨化。
2025-09-23 22:27:22 - [INFO] - [512280345618546699] [生成即摘要] 正在執行雙重輸出生成...
2025-09-23 22:27:34 - [WARNING] - [512280345618546699] Key #0 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.39 秒後進行第 2 次嘗試...
2025-09-23 22:27:36 - [WARNING] - [512280345618546699] Key #0 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.18 秒後進行第 3 次嘗試...
2025-09-23 22:27:39 - [ERROR] - [512280345618546699] Key #0 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:27:39 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #0 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:27:39 - [WARNING] - [512280345618546699] Key #1 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.18 秒後進行第 2 次嘗試...
2025-09-23 22:27:41 - [WARNING] - [512280345618546699] Key #1 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.31 秒後進行第 3 次嘗試...
2025-09-23 22:27:43 - [ERROR] - [512280345618546699] Key #1 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:27:43 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #1 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:27:44 - [WARNING] - [512280345618546699] Key #2 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.22 秒後進行第 2 次嘗試...
2025-09-23 22:27:45 - [WARNING] - [512280345618546699] Key #2 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.41 秒後進行第 3 次嘗試...
2025-09-23 22:27:48 - [ERROR] - [512280345618546699] Key #2 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:27:48 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #2 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:27:49 - [WARNING] - [512280345618546699] Key #3 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.19 秒後進行第 2 次嘗試...
2025-09-23 22:27:50 - [WARNING] - [512280345618546699] Key #3 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.25 秒後進行第 3 次嘗試...
2025-09-23 22:27:53 - [ERROR] - [512280345618546699] Key #3 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:27:53 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #3 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:27:53 - [WARNING] - [512280345618546699] Key #4 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 1.48 秒後進行第 2 次嘗試...
2025-09-23 22:27:55 - [WARNING] - [512280345618546699] Key #4 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.38 秒後進行第 3 次嘗試...
2025-09-23 22:27:58 - [ERROR] - [512280345618546699] Key #4 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:27:58 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #4 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:28:09 - [WARNING] - [512280345618546699] Key #5 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (InternalServerError)。將在 1.11 秒後進行第 2 次嘗試...
2025-09-23 22:28:10 - [WARNING] - [512280345618546699] Key #5 (模型: gemini-2.5-pro) 遭遇臨時性 API 錯誤 (ResourceExhausted)。將在 2.37 秒後進行第 3 次嘗試...
2025-09-23 22:28:13 - [ERROR] - [512280345618546699] Key #5 (模型: gemini-2.5-pro) 在 3 次內部重試後仍然失敗 (ResourceExhausted)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-23 22:28:13 - [CRITICAL] - [512280345618546699] [持久化冷卻] API Key #5 (模型: gemini-2.5-pro) 已被置入冷卻狀態，持續 24 小時。
2025-09-23 22:28:13 - [WARNING] - [512280345618546699] [Model Degradation] 模型 'gemini-2.5-pro' 的所有金鑰均嘗試失敗。正在降級到下一個模型...
2025-09-23 22:28:23 - [ERROR] - [512280345618546699] 解析 ´´´summary JSON 時失敗。內容: ```json
{
  "地點": "艾瑞亞大陸 > 寂靜之森 > 月光溪谷的隱士小屋",
  "角色互動": {
    "DINO": "命令碧拍手，被碧溫順地執行。",
    "碧": "輕柔地拍手，發出清脆聲響，並以順從、討好的語氣詢問DINO是否滿意，表達對DINO命令的遵從與渴望被認可。"
  },
  "環境描寫": "小屋內壁爐微光、寂靜、蛇尾鱗片在光下流轉。",
  "情感描寫": {
    "碧": "期待、順從、討好、渴望被認可的熱情、謹慎、恭敬。"
  },
  "關鍵字": ["拍手", "順從", "蛇人女奴", "溫順", "討好"]
}
```
2025-09-23 22:28:23 - [INFO] - [512280345618546699] [生成即摘要] 雙重輸出解析成功。
2025-09-23 22:28:24 - [INFO] - [512280345618546699] 回應已發送。正在啟動事後處理任務...
2025-09-23 22:28:29 - [INFO] - [512280345618546699] [事後處理-LORE保險] 獨立的背景LORE提取器已啟動...
2025-09-23 22:28:29 - [ERROR] - [512280345618546699] [事後處理-LORE保險] 背景LORE提取與擴展任務執行時發生未預期的異常: '"plan"'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 697, in _background_lore_extraction
    full_prompt = prompt_template.format(**extraction_params)
KeyError: '"plan"'
2025-09-23 22:35:31 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:35:31 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:35:31 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:35:31 - [INFO] - Discord Bot is ready!
2025-09-23 22:35:34 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:35:34 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:35:34 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:36:24 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 1 條文檔用於構建 BM25。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] (Retriever Builder) 純 BM25 檢索器構建成功。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-23 22:36:24 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 5 條訊息。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 啟動「生成即摘要」對話流程...
2025-09-23 22:36:24 - [INFO] - [512280345618546699] [預處理-生成即摘要] 正在準備上下文...
2025-09-23 22:36:24 - [INFO] - [512280345618546699] [導演視角] 當前錨定模式: 'local'
2025-09-23 22:36:24 - [INFO] - [512280345618546699] [導演視角] 檢測到本地互動指令，視角保持 'local'。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-23 22:36:24 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 22:36:24 - [INFO] - [512280345618546699] 正在組合混合記憶...
2025-09-23 22:36:24 - [INFO] - [512280345618546699] (RAG Cache) 檢索到 1 份文檔，正在檢查淨化快取...
2025-09-23 22:36:24 - [WARNING] - [512280345618546699] (RAG Sanitizer) 所有檢索到的文檔都未能成功淨化。
2025-09-23 22:36:24 - [ERROR] - 處理使用者 512280345618546699 的「生成即摘要」流程時發生異常: '\n#   "memory_summary"'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1073, in on_message
    final_response, summary_data = await ai_instance.preprocess_and_generate(input_data)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1986, in preprocess_and_generate
    full_prompt = full_template.format(**full_prompt_params)
KeyError: '\n#   "memory_summary"'
2025-09-23 22:40:48 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:40:48 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:40:49 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:40:49 - [INFO] - Discord Bot is ready!
2025-09-23 22:40:51 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:40:51 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:40:52 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:41:13 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 1 條文檔用於構建 BM25。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] (Retriever Builder) 純 BM25 檢索器構建成功。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-23 22:41:13 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 5 條訊息。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 啟動「生成即摘要」對話流程...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [預處理-生成即摘要] 正在準備上下文...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [導演視角] 當前錨定模式: 'local'
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [導演視角] 檢測到本地互動指令，視角保持 'local'。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-23 22:41:13 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] 正在組合混合記憶...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] (RAG Cache) 檢索到 1 份文檔，正在檢查淨化快取...
2025-09-23 22:41:13 - [WARNING] - [512280345618546699] (RAG Sanitizer) 所有檢索到的文檔都未能成功淨化。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [生成即摘要] 正在執行雙重輸出生成...
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #0 (針對模型 gemini-2.5-pro，剩餘 85586 秒)。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #1 (針對模型 gemini-2.5-pro，剩餘 85590 秒)。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #2 (針對模型 gemini-2.5-pro，剩餘 85595 秒)。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #3 (針對模型 gemini-2.5-pro，剩餘 85600 秒)。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #4 (針對模型 gemini-2.5-pro，剩餘 85605 秒)。
2025-09-23 22:41:13 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #5 (針對模型 gemini-2.5-pro，剩餘 85620 秒)。
2025-09-23 22:41:13 - [WARNING] - [512280345618546699] [API 警告] 針對模型 'gemini-2.5-pro'，所有 API 金鑰當前都處於冷卻期。
2025-09-23 22:41:13 - [WARNING] - [512280345618546699] 在模型 'gemini-2.5-pro' 的嘗試中，所有 API 金鑰均處於長期冷卻期。
2025-09-23 22:41:13 - [WARNING] - [512280345618546699] [Model Degradation] 模型 'gemini-2.5-pro' 的所有金鑰均嘗試失敗。正在降級到下一個模型...
2025-09-23 22:41:29 - [INFO] - [512280345618546699] [生成即摘要] 雙重輸出解析成功。
2025-09-23 22:41:29 - [INFO] - [512280345618546699] 回應已發送。正在啟動事後處理任務...
2025-09-23 22:41:29 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-09-23 22:41:29 - [INFO] - [512280345618546699] [長期記憶寫入] 安全存檔已成功保存到 SQL 資料庫。
2025-09-23 22:41:29 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-09-23 22:41:34 - [INFO] - [512280345618546699] [事後處理-LORE保險] 獨立的背景LORE提取器已啟動...
2025-09-23 22:41:36 - [INFO] - [512280345618546699] [事後處理-LORE保險] 提取到 1 條新LORE，準備執行擴展...
2025-09-23 22:41:36 - [INFO] - --- [512280345618546699] (LORE Executor) 開始串行執行 1 個修正後的LORE任务 ---
2025-09-23 22:41:36 - [WARNING] - [512280345618546699] [自動修正-邏輯] AI 試圖更新一個不存在的NPC (key: None)。已自動將操作轉換為創建新NPC。
2025-09-23 22:41:36 - [ERROR] - [512280345618546699] (LORE Executor) 任務失敗: for create_new_npc_profile: 1 validation error for CreateNewNpcProfileArgs
lore_key
  Field required [type=missing, input_value={'npc_name': '碧', 'desc...溪谷的隱士小屋']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1621, in _execute_tool_call_plan
    validated_args = tool_to_execute.args_schema.model_validate(call.parameters)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
pydantic_core._pydantic_core.ValidationError: 1 validation error for CreateNewNpcProfileArgs
lore_key
  Field required [type=missing, input_value={'npc_name': '碧', 'desc...溪谷的隱士小屋']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
2025-09-23 22:41:36 - [INFO] - --- [512280345618546699] (LORE Executor) LORE 扩展計畫执行完毕 ---
2025-09-23 22:41:36 - [INFO] - [512280345618546699] LORE 數據已更新，正在強制重建 RAG 知識庫索引...
2025-09-23 22:41:36 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 2 條文檔用於構建 BM25。
2025-09-23 22:41:36 - [INFO] - [512280345618546699] (Retriever Builder) 純 BM25 檢索器構建成功。
2025-09-23 22:41:36 - [INFO] - [512280345618546699] RAG 知識庫索引已成功更新。
2025-09-23 22:41:36 - [INFO] - [512280345618546699] (LORE Executor) 背景任务的工具上下文已清理。
2025-09-23 22:46:21 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:46:21 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:46:21 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:46:21 - [INFO] - Discord Bot is ready!
2025-09-23 22:46:24 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:46:24 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:46:24 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:55:04 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 22:55:04 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 22:55:04 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 22:55:04 - [INFO] - Discord Bot is ready!
2025-09-23 22:55:07 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 22:55:07 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 22:55:08 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 22:55:40 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 22:55:40 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 22:55:40 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 22:55:40 - [INFO] - [512280345618546699] (Retriever Builder) 未找到持久化 RAG 索引，正在從資料庫執行一次性全量創始構建...
2025-09-23 22:55:40 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 2 條文檔用於創始構建。
2025-09-23 22:55:40 - [ERROR] - [512280345618546699] 配置前置資源時發生致命錯誤: name 'pickle' is not defined
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 247, in _save_bm25_corpus
    pickle.dump(self.bm25_corpus, f)
NameError: name 'pickle' is not defined

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1508, in initialize
    await self._configure_pre_requisites()
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 2308, in _configure_pre_requisites
    self.retriever = await self._load_or_build_rag_retriever()
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 340, in _load_or_build_rag_retriever
    self._save_bm25_corpus() # 將首次構建的結果持久化
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 248, in _save_bm25_corpus
    except (IOError, pickle.PicklingError) as e:
NameError: name 'pickle' is not defined
2025-09-23 22:55:40 - [WARNING] - 為使用者 512280345618546699 初始化 AI 實例失敗。
2025-09-23 23:01:02 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-23 23:01:02 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-23 23:01:03 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-23 23:01:03 - [INFO] - Discord Bot is ready!
2025-09-23 23:01:06 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-23 23:01:06 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-23 23:01:07 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-23 23:01:16 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-23 23:01:16 - [ERROR] - [512280345618546699] [RAG持久化] 加載 BM25 語料庫失敗: Ran out of input。將觸發全量重建。
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 260, in _load_bm25_corpus
    self.bm25_corpus = pickle.load(f)
EOFError: Ran out of input
2025-09-23 23:01:16 - [INFO] - [512280345618546699] (Retriever Builder) 未找到持久化 RAG 索引，正在從資料庫執行一次性全量創始構建...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 2 條文檔用於創始構建。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] (Retriever Builder) 創始構建成功，並已將索引持久化到磁碟。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-23 23:01:16 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 7 條訊息。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 啟動「生成即摘要」對話流程...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] [預處理-生成即摘要] 正在準備上下文...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] [導演視角] 當前錨定模式: 'local'
2025-09-23 23:01:16 - [INFO] - [512280345618546699] [導演視角] 檢測到本地互動指令，視角保持 'local'。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-23 23:01:16 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-23 23:01:16 - [INFO] - [512280345618546699] 正在組合混合記憶...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] (RAG Cache) 檢索到 2 份文檔，正在檢查淨化快取...
2025-09-23 23:01:16 - [INFO] - [512280345618546699] (RAG Summarizer) 成功淨化 1/2 份文檔，正在進行最終摘要...
