### AI Lover Log - Last updated at 2025-09-09T22:44:58.426148 ###

2025-09-09 22:33:50 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #5 創建。下一次將使用 Key #6。
2025-09-09 22:33:53 - [WARNING] - [512280345618546699] 鏈遭遇內容審查，且重試策略為 'none'。為防止循環錯誤，將立即終止並返回 None。
2025-09-09 22:33:53 - [WARNING] - [512280345618546699] (History Summarizer) [L1] 直接摘要失敗: ValueError。啟動【L2 文學評論家】安全備援...
2025-09-09 22:33:53 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #0 創建。下一次將使用 Key #1。
2025-09-09 22:33:56 - [WARNING] - [512280345618546699] 鏈遭遇內容審查，且重試策略為 'none'。為防止循環錯誤，將立即終止並返回 None。
2025-09-09 22:33:56 - [ERROR] - [512280345618546699] (History Summarizer) [L2] 文學評論家備援最終失敗: ValueError。啟動【L3 原始文本】終極備援。
2025-09-09 22:33:56 - [INFO] - [512280345618546699] (History Summarizer) [L3] 終極備援成功，已提取並淨化最後一條AI回應作為上下文。
2025-09-09 22:34:02 - [WARNING] - [512280345618546699] 內部鏈意外遭遇審查。啟動【解構-重構委婉化】策略...
2025-09-09 22:34:02 - [ERROR] - [512280345618546699] (Euphemizer) 待處理文本長度 (11526) 超過 4000 字符上限，為避免效能問題已跳過委婉化重試。
2025-09-09 22:34:02 - [INFO] - [512280345618546699] (Graph|8) Node: tool_execution -> 正在執行行動計劃中的工具...
2025-09-09 22:34:02 - [INFO] - [512280345618546699] (Graph|9 SFW) Node: sfw_narrative_rendering -> 正在將 SFW 行動計劃渲染為小說...
2025-09-09 22:34:02 - [INFO] - [512280345618546699] (Graph|10) Node: validate_and_rewrite -> 正在對 LLM 原始輸出進行內容保全式淨化...
2025-09-09 22:34:02 - [INFO] - [512280345618546699] (Graph|11) Node: persist_state -> 正在持久化狀態與記憶...
2025-09-09 22:34:03 - [INFO] - [512280345618546699] (Persist) 正在將 LORE 提取任務分派到背景執行...
2025-09-09 22:34:03 - [ERROR] - [512280345618546699] 背景LORE提取與擴展任務執行時發生未預期的異常: cannot import name 'ValidationError' from 'src.schemas' (D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\schemas.py)
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1134, in _background_lore_extraction
    try:
ImportError: cannot import name 'ValidationError' from 'src.schemas' (D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\schemas.py)
2025-09-09 22:34:39 - [INFO] - Discord Bot is ready and commands are synced!
2025-09-09 22:34:42 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-09 22:34:42 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-09 22:34:43 - [INFO] - 已成功發送啟動成功通知給管理員 (ID: 512280345618546699)。
2025-09-09 22:38:43 - [INFO] - [512280345618546699] 後台重置任務開始...
2025-09-09 22:38:43 - [INFO] - [512280345618546699] 已從 SQL 資料庫安全地清除了所有相關記錄。
2025-09-09 22:38:43 - [INFO] - [512280345618546699] (第 1 次嘗試) 已成功刪除向量數據庫目錄。
2025-09-09 22:38:49 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-09 22:38:49 - [INFO] - [512280345618546699] 處於設定流程中，即使資料庫無記錄，也創建一個臨時的記憶體實例。
2025-09-09 22:38:49 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['world_settings']
2025-09-09 22:38:49 - [WARNING] - [512280345618546699] 在持久化更新時找不到使用者資料，將創建新記錄。
2025-09-09 22:38:49 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-09 22:39:00 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile']
2025-09-09 22:39:00 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-09 22:39:13 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['ai_profile']
2025-09-09 22:39:13 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-09 22:39:21 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #1 創建。下一次將使用 Key #2。
2025-09-09 22:39:22 - [INFO] - [512280345618546699] 資料庫為空，暫時使用純向量檢索器作為基礎。
2025-09-09 22:39:23 - [INFO] - [512280345618546699] RAG 系統升級：成功啟用 Cohere Rerank，已配置先進的「檢索+重排」流程。
2025-09-09 22:39:23 - [INFO] - [512280345618546699] 正在處理 'canon' 向量化批次 1/1 (使用 API Key #2)...
2025-09-09 22:39:24 - [INFO] - [512280345618546699] 批次 1 成功處理。
2025-09-09 22:39:24 - [INFO] - [512280345618546699] /start 流程：正在強制初始化 AI 核心組件...
2025-09-09 22:39:24 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] 已成功加載 4 個戰術指令模組: 00_core_protocol, 00_supreme_directive, action_macro_movement, action_sexual_content
2025-09-09 22:39:25 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #2 創建。下一次將使用 Key #3。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] 成功創建基礎混合式 EnsembleRetriever (語義 + BM25)。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] RAG 系統升級：成功啟用 Cohere Rerank，已配置先進的「檢索+重排」流程。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] 已從向量儲存中清理了 1 條舊的 'canon' 記錄。
2025-09-09 22:39:25 - [INFO] - [512280345618546699] 正在處理 'canon' 向量化批次 1/1 (使用 API Key #3)...
2025-09-09 22:39:26 - [INFO] - [512280345618546699] 批次 1 成功處理。
2025-09-09 22:39:26 - [INFO] - [512280345618546699] 開始智能解析世界聖經文本...
2025-09-09 22:39:26 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #3 創建。下一次將使用 Key #4。
2025-09-09 22:39:30 - [INFO] - [512280345618546699] 正在處理 'npc_profile' 類別的 1 個實體...
2025-09-09 22:39:30 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #4 創建。下一次將使用 Key #5。
2025-09-09 22:39:35 - [INFO] - [512280345618546699] 已為新實體 'DINO' (標準名: Dino) 創建了 LORE 條目，主鍵為 'Dino'。
2025-09-09 22:39:35 - [INFO] - [512280345618546699] 正在處理 'location_info' 類別的 1 個實體...
2025-09-09 22:39:40 - [INFO] - [512280345618546699] 已為新實體 '性神城' (標準名: 性神城) 創建了 LORE 條目，主鍵為 '性神城'。
2025-09-09 22:39:40 - [INFO] - [512280345618546699] 正在處理 'creature_info' 類別的 1 個實體...
2025-09-09 22:39:45 - [INFO] - [512280345618546699] 已為新實體 '天空龍' (標準名: 天空龍) 創建了 LORE 條目，主鍵為 '天空龍'。
2025-09-09 22:39:45 - [INFO] - [512280345618546699] 正在處理 'world_lore' 類別的 2 個實體...
2025-09-09 22:39:50 - [INFO] - [512280345618546699] 已為新實體 '性神恩澤' (標準名: 性神恩澤) 創建了 LORE 條目，主鍵為 '性神恩澤'。
2025-09-09 22:39:55 - [INFO] - [512280345618546699] 已為新實體 '性神教' (標準名: 性神教) 創建了 LORE 條目，主鍵為 '性神教'。
2025-09-09 22:39:55 - [INFO] - [512280345618546699] 世界聖經智能解析與 LORE 創建完成。
2025-09-09 22:39:55 - [INFO] - [512280345618546699] (Setup Graph) Node: complete_profiles_node -> 正在補完角色檔案...
2025-09-09 22:39:55 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #5 創建。下一次將使用 Key #6。
2025-09-09 22:39:56 - [INFO] - [512280345618546699] 正在為角色 'DINO' 執行安全的檔案補完...
2025-09-09 22:39:57 - [INFO] - [512280345618546699] 正在為角色 '碧' 執行安全的檔案補完...
2025-09-09 22:40:00 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile', 'ai_profile']
2025-09-09 22:40:00 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-09 22:40:00 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #0 創建。下一次將使用 Key #1。
2025-09-09 22:40:05 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-09 22:40:05 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-09 22:40:23 - [INFO] - [512280345618546699] 接收到來自 'dinosonicgo' 在頻道 'Direct Message with Unknown User' 中的消息: '坐下...'
2025-09-09 22:40:23 - [INFO] - [512280345618546699] 响应条件满足，启动 LangGraph 對話流程...
2025-09-09 22:40:24 - [INFO] - [512280345618546699] (Graph|1) Node: classify_intent -> 正在進行初步輸入類型分析...
2025-09-09 22:40:24 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #1 創建。下一次將使用 Key #2。
2025-09-09 22:40:24 - [INFO] - [512280345618546699] (Graph|1) 正在对具体指令 '坐下...' 進行意圖分類...
2025-09-09 22:40:24 - [INFO] - [512280345618546699] LLM 實例已使用 API Key #2 創建。下一次將使用 Key #3。
2025-09-09 22:40:25 - [INFO] - [512280345618546699] (Router 1) 檢測到SFW意圖，進入【快速通道】。
2025-09-09 22:40:25 - [INFO] - [512280345618546699] (Graph) Node: perceive_and_set_view -> 正在基於意圖 'sfw' 统一处理感知与视角...
2025-09-09 22:40:25 - [INFO] - [512280345618546699] (Perception Hub) GameState 无需更新。
2025-09-09 22:40:25 - [ERROR] - 處理使用者 512280345618546699 的 LangGraph 聊天流程時發生未捕獲的異常: KeyError: 'sanitized_query_for_tools'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1211, in on_message
    final_state = await self.main_response_graph.ainvoke(initial_state)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 3088, in ainvoke
    async for chunk in self.astream(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 2926, in astream
    async for _ in runner.atick(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_runner.py", line 295, in atick
    await arun_with_retry(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_retry.py", line 137, in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 693, in ainvoke
    input = await step.ainvoke(input, config, **kwargs)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 457, in ainvoke
    ret = await self.afunc(*args, **kwargs)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\graph.py", line 164, in query_lore_node
    safe_query_text = state['sanitized_query_for_tools']
KeyError: 'sanitized_query_for_tools'
