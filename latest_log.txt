### AI Lover Log - Last updated at 2025-09-28T09:47:38.856700 ###

2025-09-28 00:50:52 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-28 00:50:52 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 114 條文檔到 RAG 語料庫。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] (Retriever Builder) 已成功從持久化檔案構建 RAG 檢索器。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-28 00:50:53 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-28 00:50:53 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 3 條訊息。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] [撤銷] 已成功從場景 '512280345618546699_local_王國_王都城鎮區_咆哮壁爐酒館' 的短期記憶中撤銷上一回合。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] [撤銷-後端] 正在嘗試從資料庫刪除最新一條長期記憶...
2025-09-28 00:50:53 - [INFO] - [512280345618546699] [撤銷-後端] ✅ 成功刪除 ID 為 31 的長期記憶。
2025-09-28 00:50:53 - [INFO] - [512280345618546699] [撤銷] 處於DM頻道，跳過刪除使用者訊息的步驟。
2025-09-28 00:50:58 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 00:50:58 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 00:50:58 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 00:50:58 - [INFO] - [512280345618546699] [LORE錨定] 正在為指令中提及的 ['米婭'] 強制查找LORE檔案...
2025-09-28 00:50:59 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 00:50:59 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 00:50:59 - [INFO] - [512280345618546699] RAG查詢已擴展為: 'Mia 米婭 聖露修道院 描述米婭在宅邸散步遇到勛爵 母畜 活神蹟 聖女'
2025-09-28 00:50:59 - [INFO] - [512280345618546699] [RAG後處理篩選] 已將 15 條初步檢索結果精煉為 12 條與核心角色相關的記憶。
2025-09-28 00:50:59 - [INFO] - [512280345618546699] [RAG摘要-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 00:50:59 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 00:50:59 - [WARNING] - [512280345618546699] [RAG摘要-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 00:51:00 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 00:51:00 - [ERROR] - [512280345618546699] [RAG摘要-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4777, in retrieve_and_summarize_memories
    summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4795, in retrieve_and_summarize_memories
    encoded_summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 00:51:00 - [WARNING] - [512280345618546699] [RAG摘要] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 00:51:00 - [INFO] - [512280345618546699] [RAG摘要-2A] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行摘要...
2025-09-28 00:51:14 - [INFO] - [512280345618546699] [RAG摘要-2A] ✅ 本地模型摘要成功。
2025-09-28 00:51:14 - [INFO] - [512280345618546699] 已成功將 RAG 結果分離為 3 條規則全文和 9 條待摘要文檔。
2025-09-28 00:51:15 - [INFO] - [512280345618546699] [純粹生成流程] 正在執行小說生成...
2025-09-28 00:52:00 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #3.
2025-09-28 00:52:03 - [INFO] - [512280345618546699] [純粹生成流程] 小說文本生成成功，並已為事後分析創建詳細上下文快照。
2025-09-28 00:52:03 - [INFO] - [512280345618546699] 回應已發送。正在啟動統一的「事後分析」任務...
2025-09-28 00:52:05 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析任務...
2025-09-28 00:52:07 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #4.
2025-09-28 00:52:07 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-09-28 00:52:08 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-09-28 00:52:08 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-09-28 00:52:08 - [INFO] - [512280345618546699] [事後分析] 背景分析與處理任務完成。
2025-09-28 00:56:04 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 00:56:04 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 00:58:18 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 00:58:18 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 00:58:18 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 00:58:18 - [INFO] - Discord Bot is ready!
2025-09-28 00:58:22 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 00:58:22 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 00:58:28 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-28 00:58:28 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 114 條文檔到 RAG 語料庫。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] (Retriever Builder) 已成功從持久化檔案構建 RAG 檢索器。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-28 00:58:28 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-28 00:58:28 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 5 條訊息。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] [撤銷] 已成功從場景 '512280345618546699_local_王國_王都城鎮區_咆哮壁爐酒館' 的短期記憶中撤銷上一回合。
2025-09-28 00:58:28 - [INFO] - [512280345618546699] [撤銷-後端] 正在嘗試從資料庫刪除最新一條長期記憶...
2025-09-28 00:58:28 - [INFO] - [512280345618546699] [撤銷-後端] ✅ 成功刪除 ID 為 31 的長期記憶。
2025-09-28 00:58:32 - [INFO] - [512280345618546699] [撤銷] 處於DM頻道，跳過刪除使用者訊息的步驟。
2025-09-28 00:58:33 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 00:58:33 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 00:58:33 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 00:58:33 - [INFO] - [512280345618546699] [LORE錨定] 正在為指令中提及的 ['米婭'] 強制查找LORE檔案...
2025-09-28 00:58:34 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 00:58:34 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 00:58:34 - [INFO] - [512280345618546699] RAG查詢已擴展為: '聖女 母畜 描述米婭在宅邸散步遇到勛爵 米婭 聖露修道院 Mia 活神蹟'
2025-09-28 00:58:34 - [INFO] - [512280345618546699] [RAG後處理篩選] 已將 15 條初步檢索結果精煉為 12 條與核心角色相關的記憶。
2025-09-28 00:58:34 - [INFO] - [512280345618546699] [RAG摘要-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 00:58:34 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 00:58:34 - [WARNING] - [512280345618546699] [RAG摘要-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 00:58:34 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 00:58:35 - [ERROR] - [512280345618546699] [RAG摘要-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4773, in retrieve_and_summarize_memories
    summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4795, in retrieve_and_summarize_memories
    encoded_summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 00:58:35 - [WARNING] - [512280345618546699] [RAG摘要] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 00:58:35 - [INFO] - [512280345618546699] [RAG摘要-2A] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行摘要...
2025-09-28 00:58:40 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 01:03:48 - [CRITICAL] - 【重大錯誤】與 Discord 的 WebSocket 連線已中斷！
2025-09-28 01:03:48 - [INFO] - [512280345618546699] [RAG摘要-2A] ✅ 本地模型摘要成功。
2025-09-28 01:03:48 - [INFO] - [512280345618546699] 已成功將 RAG 結果分離為 3 條規則全文和 9 條待摘要文檔。
2025-09-28 01:03:51 - [INFO] - [512280345618546699] [純粹生成流程] 正在執行小說生成...
2025-09-28 01:03:57 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 01:04:38 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #3.
2025-09-28 01:04:40 - [INFO] - [512280345618546699] [純粹生成流程] 小說文本生成成功，並已為事後分析創建詳細上下文快照。
2025-09-28 01:04:40 - [INFO] - [512280345618546699] 回應已發送。正在啟動統一的「事後分析」任務...
2025-09-28 01:04:42 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析任務...
2025-09-28 01:04:45 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #4.
2025-09-28 01:04:45 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-09-28 01:04:45 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-09-28 01:04:45 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-09-28 01:04:45 - [INFO] - [512280345618546699] [事後分析] 背景分析與處理任務完成。
2025-09-28 01:19:26 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 01:19:26 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 01:19:27 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 01:19:27 - [INFO] - Discord Bot is ready!
2025-09-28 01:19:29 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 01:19:29 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 01:19:30 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 01:42:33 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 01:42:33 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 01:42:33 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 01:42:33 - [INFO] - Discord Bot is ready!
2025-09-28 01:42:36 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 01:42:36 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 01:42:37 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 01:42:57 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-28 01:42:57 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 114 條文檔到 RAG 語料庫。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] (Retriever Builder) 已成功從持久化檔案構建 RAG 檢索器。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-28 01:42:57 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-28 01:42:57 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 7 條訊息。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] [撤銷] 已成功從場景 '512280345618546699_local_王國_王都城鎮區_咆哮壁爐酒館' 的短期記憶中撤銷上一回合。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] [撤銷-後端] 正在嘗試從資料庫刪除最新一條長期記憶...
2025-09-28 01:42:57 - [INFO] - [512280345618546699] [撤銷-後端] ✅ 成功刪除 ID 為 31 的長期記憶。
2025-09-28 01:42:57 - [INFO] - [512280345618546699] [撤銷] 處於DM頻道，跳過刪除使用者訊息的步驟。
2025-09-28 01:43:18 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 01:43:18 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 01:43:18 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 01:43:18 - [INFO] - [512280345618546699] [LORE錨定] 正在為指令中提及的 ['米婭'] 強制查找LORE檔案...
2025-09-28 01:43:21 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 01:43:21 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 01:43:21 - [INFO] - [512280345618546699] RAG查詢已擴展為: '聖露修道院 Mia 母畜 活神蹟 米婭 描述米婭在宅邸打掃遇到勛爵 聖女'
2025-09-28 01:43:21 - [INFO] - [512280345618546699] [RAG後處理篩選] 已將 15 條初步檢索結果精煉為 12 條與核心角色相關的記憶。
2025-09-28 01:43:21 - [INFO] - [512280345618546699] [RAG摘要-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 01:43:33 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 01:43:33 - [WARNING] - [512280345618546699] [RAG摘要-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 01:44:37 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 01:44:37 - [ERROR] - [512280345618546699] [RAG摘要-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4930, in retrieve_and_summarize_memories
    summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4952, in retrieve_and_summarize_memories
    encoded_summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 01:44:37 - [WARNING] - [512280345618546699] [RAG摘要] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 01:44:37 - [INFO] - [512280345618546699] [RAG摘要-2A] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行摘要...
2025-09-28 01:45:28 - [INFO] - [512280345618546699] [RAG摘要-2A] ✅ 本地模型摘要成功。
2025-09-28 01:45:28 - [INFO] - [512280345618546699] 已成功將 RAG 結果分離為 3 條規則全文和 9 條待摘要文檔。
2025-09-28 01:45:30 - [INFO] - [512280345618546699] [AI導演] 正在啟動導演決策模組...
2025-09-28 01:45:30 - [WARNING] - [512280345618546699] [AI導演] 雲端導演決策失敗: name 'NarrativeDirective' is not defined。正在啟動本地備援...
2025-09-28 01:45:30 - [INFO] - [512280345618546699] [AI導演-備援] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行導演決策...
2025-09-28 01:45:40 - [ERROR] - [512280345618546699] [AI導演-備援] 🔥 呼叫本地Ollama進行導演決策時發生未知錯誤: 1 validation error for NarrativeDirective
scene_summary_for_generation
  Input should be a valid string [type=string_type, input_value={'description': 'Mia, a s...ocation': 'the mansion'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 3092, in _invoke_local_ollama_director
    validated_result = NarrativeDirective.model_validate(parsed_json)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
pydantic_core._pydantic_core.ValidationError: 1 validation error for NarrativeDirective
scene_summary_for_generation
  Input should be a valid string [type=string_type, input_value={'description': 'Mia, a s...ocation': 'the mansion'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-09-28 01:45:40 - [ERROR] - 處理使用者 512280345618546699 的「純粹生成」流程時發生異常: name 'NarrativeDirective' is not defined
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1507, in on_message
    final_response = await ai_instance.preprocess_and_generate(input_data)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 2886, in preprocess_and_generate
    directive = NarrativeDirective(
NameError: name 'NarrativeDirective' is not defined
2025-09-28 01:49:10 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 01:49:10 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 01:49:10 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 01:49:10 - [INFO] - Discord Bot is ready!
2025-09-28 01:49:13 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 01:49:13 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 01:49:14 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 01:49:24 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 114 條文檔到 RAG 語料庫。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] (Retriever Builder) 已成功從持久化檔案構建 RAG 檢索器。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-28 01:49:25 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 7 條訊息。
2025-09-28 01:49:25 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 01:49:25 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 01:49:25 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 01:49:25 - [INFO] - [512280345618546699] [LORE錨定] 正在為指令中提及的 ['米婭'] 強制查找LORE檔案...
2025-09-28 01:49:29 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 01:49:29 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 01:49:29 - [INFO] - [512280345618546699] RAG查詢已擴展為: 'Mia 聖女 米婭 描述米婭在宅邸打掃遇到勛爵 聖露修道院 母畜 活神蹟'
2025-09-28 01:49:29 - [INFO] - [512280345618546699] [RAG後處理篩選] 已將 15 條初步檢索結果精煉為 12 條與核心角色相關的記憶。
2025-09-28 01:49:29 - [INFO] - [512280345618546699] [RAG摘要-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 01:49:44 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 01:49:44 - [WARNING] - [512280345618546699] [RAG摘要-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 01:49:58 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 01:49:58 - [ERROR] - [512280345618546699] [RAG摘要-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4941, in retrieve_and_summarize_memories
    summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4963, in retrieve_and_summarize_memories
    encoded_summary = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 01:49:58 - [WARNING] - [512280345618546699] [RAG摘要] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 01:49:58 - [INFO] - [512280345618546699] [RAG摘要-2A] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行摘要...
2025-09-28 01:52:00 - [INFO] - [512280345618546699] [RAG摘要-2A] ✅ 本地模型摘要成功。
2025-09-28 01:52:00 - [INFO] - [512280345618546699] 已成功將 RAG 結果分離為 3 條規則全文和 9 條待摘要文檔。
2025-09-28 01:52:00 - [INFO] - [512280345618546699] [AI導演] 正在啟動導演決策模組...
2025-09-28 01:52:01 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-09-28 01:52:01 - [INFO] - [512280345618546699] [AI導演] 決策完成。強制動作: '無'
2025-09-28 01:52:01 - [INFO] - [512280345618546699] [純粹生成流程] 正在執行小說生成...
2025-09-28 01:52:43 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #4.
2025-09-28 01:52:45 - [INFO] - [512280345618546699] [純粹生成流程] 小說文本生成成功，並已為事後分析創建詳細上下文快照。
2025-09-28 01:52:45 - [INFO] - [512280345618546699] 回應已發送。正在啟動統一的「事後分析」任務...
2025-09-28 01:52:47 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析任務...
2025-09-28 01:52:50 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #5.
2025-09-28 01:52:50 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-09-28 01:52:51 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-09-28 01:52:51 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-09-28 01:52:51 - [INFO] - [512280345618546699] [事後分析] 背景分析與處理任務完成。
2025-09-28 01:54:43 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 01:54:43 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 01:54:43 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 01:54:43 - [INFO] - Discord Bot is ready!
2025-09-28 01:54:46 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 01:54:46 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 01:54:46 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 09:15:05 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 09:15:05 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 09:15:06 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 09:15:06 - [INFO] - Discord Bot is ready!
2025-09-28 09:15:09 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 09:15:09 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 09:15:10 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 09:32:14 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 09:32:14 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 09:32:15 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 09:32:15 - [INFO] - Discord Bot is ready!
2025-09-28 09:32:17 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 09:32:17 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 09:32:18 - [INFO] - 已成功發送啟動成功通知給管理員。
