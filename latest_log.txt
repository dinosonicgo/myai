### AI Lover Log - Last updated at 2025-09-28T16:36:32.690379 ###

2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 創建反向鏈接: 愛蓮娜 -> 連恩 (Roles: ['妻子'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 費奇 -> 連恩 (New Roles: ['岳父子', '女婿'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 卡爾•維利爾斯勳爵 -> 絲月 (New Roles: ['僕人', '引導者', '主人', '丈夫'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 艾莉諾 -> 布魯諾 (New Roles: ['被使用者', '園丁', '使用者/被使用者'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 馬丁 -> 老高 (New Roles: ['被引導者', '栽培對象'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 亞瑟 -> 老高 (New Roles: ['被引導者', '栽培對象'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 創建反向鏈接: 莉莉絲 -> 亞瑟 (Roles: ['引導者/被引導者'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 老高 -> 亞瑟 (New Roles: ['引導者/被引導者', '栽培對象'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 創建反向鏈接: 莉莉絲 -> 馬丁 (Roles: ['引導者/被引導者'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 老高 -> 馬丁 (New Roles: ['引導者/被引導者', '栽培對象'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 大皇子阿拉里克 -> 國王埃德蒙三世 (New Roles: ['父子', '兒子'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 三皇子赫克托 -> 國王埃德蒙三世 (New Roles: ['父子', '兒子'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 二公主塞拉菲娜 -> 國王埃德蒙三世 (New Roles: ['女兒', '父女'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 三皇女伊索爾德 -> 國王埃德蒙三世 (New Roles: ['計劃制定者', '女兒', '父女'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 博林勳爵 -> 國王埃德蒙三世 (New Roles: ['下屬', '下屬/上級'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 大主教安布羅斯 -> 國王埃德蒙三世 (New Roles: ['施壓者/被施壓者', '施壓者'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] [關係圖譜校準] 更新反向鏈接: 三皇女伊索爾德 -> 博林勳爵 (New Roles: ['神之禮物', '誘惑者/被誘惑者', '誘惑者'])
2025-09-28 16:11:05 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'npc_profile' 類別處理 157 個實體...
2025-09-28 16:13:00 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-09-28 16:13:00 - [INFO] - [512280345618546699] [實體解析] 成功生成解析計畫，包含 157 條決策。
2025-09-28 16:13:06 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'location_info' 類別處理 10 個實體...
2025-09-28 16:13:07 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'item_info' 類別處理 3 個實體...
2025-09-28 16:13:07 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'world_lore' 類別處理 18 個實體...
2025-09-28 16:13:09 - [INFO] - [512280345618546699] [創世 LORE 解析] 管線成功完成。正在觸發 RAG 全量重建...
2025-09-28 16:13:09 - [INFO] - [512280345618546699] (Retriever Builder) 強制重建觸發，正在從資料庫執行全量創始構建...
2025-09-28 16:13:09 - [INFO] - [512280345618546699] (Retriever Builder) 已從 SQL 和 LORE 加載 126 條文檔用於創始構建。
2025-09-28 16:13:09 - [INFO] - [512280345618546699] (Retriever Builder) 創始構建成功，並已將索引持久化到磁碟。
2025-09-28 16:13:09 - [INFO] - [512280345618546699] [創世 LORE 解析] RAG 索引全量重建完成。
2025-09-28 16:13:09 - [INFO] - [512280345618546699] [后台创世 1/4] LORE 智能解析已同步完成。
2025-09-28 16:13:09 - [INFO] - [512280345618546699] [后台创世 2/4] 正在补完角色档案...
2025-09-28 16:13:11 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #2.
2025-09-28 16:13:12 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #1.
2025-09-28 16:13:12 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile', 'ai_profile']
2025-09-28 16:13:12 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-28 16:13:12 - [INFO] - [512280345618546699] [后台创世 3/4] 正在生成世界创世资讯...
2025-09-28 16:13:12 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #3) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 16:13:12 - [WARNING] - [512280345618546699] 最終生成鏈遭遇審查。啟動【最高指令集注入重試】策略...
2025-09-28 16:13:12 - [INFO] - [512280345618546699] 已對 Prompt 附加完整的核心指令集，正在進行強化重試...
2025-09-28 16:13:49 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #4.
2025-09-28 16:13:49 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-09-28 16:13:50 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-09-28 16:13:50 - [INFO] - [512280345618546699] [/start] 初始地點 '埃德蒙王國 > 王都 > 咆哮壁爐酒館' 已成功生成並存入LORE。
2025-09-28 16:13:50 - [INFO] - [512280345618546699] [后台创世 4/4] 正在生成开场白...
2025-09-28 16:14:31 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #5.
2025-09-28 16:14:31 - [INFO] - [512280345618546699] [后台创世 4/4] 开场白生成完毕。
2025-09-28 16:14:31 - [INFO] - [512280345618546699] [后台创世] 正在向使用者私讯发送最终开场白...
2025-09-28 16:14:31 - [INFO] - [512280345618546699] [后台创世] 开场白发送完毕。
2025-09-28 16:14:31 - [INFO] - [512280345618546699] 后台创世流程结束，状态锁已释放。
2025-09-28 16:25:46 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 16:25:46 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 16:25:46 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 16:25:47 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 16:25:47 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 16:25:47 - [INFO] - [512280345618546699] [RAG查詢強化] 查詢已擴展為: '描述米婭在宅邸散步遇到維利爾斯勛爵 Mia 蒙恩者 活神蹟 米婭 母畜 聖女'
2025-09-28 16:25:47 - [INFO] - [512280345618546699] [RAG事實提取-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 16:25:47 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 16:25:47 - [WARNING] - [512280345618546699] [RAG事實提取-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 16:25:48 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 16:25:48 - [ERROR] - [512280345618546699] [RAG事實提取-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4961, in retrieve_and_summarize_memories
    fact_sheet = await self.ainvoke_with_rotation(full_prompt, output_schema=RagFactSheet, retry_strategy='none')
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4969, in retrieve_and_summarize_memories
    fact_sheet = await self.ainvoke_with_rotation(full_prompt, output_schema=RagFactSheet, retry_strategy='none')
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 16:25:48 - [WARNING] - [512280345618546699] [RAG事實提取] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 16:25:48 - [WARNING] - [512280345618546699] Key #3 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.42 秒後進行第 2 次嘗試...
2025-09-28 16:25:50 - [WARNING] - [512280345618546699] Key #3 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.15 秒後進行第 3 次嘗試...
2025-09-28 16:25:52 - [ERROR] - [512280345618546699] Key #3 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:25:52 - [WARNING] - [512280345618546699] Key #4 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.24 秒後進行第 2 次嘗試...
2025-09-28 16:25:53 - [WARNING] - [512280345618546699] Key #4 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.44 秒後進行第 3 次嘗試...
2025-09-28 16:25:56 - [ERROR] - [512280345618546699] Key #4 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:25:56 - [WARNING] - [512280345618546699] Key #5 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.14 秒後進行第 2 次嘗試...
2025-09-28 16:25:58 - [WARNING] - [512280345618546699] Key #5 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.46 秒後進行第 3 次嘗試...
2025-09-28 16:26:00 - [ERROR] - [512280345618546699] Key #5 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:26:00 - [WARNING] - [512280345618546699] Key #0 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.30 秒後進行第 2 次嘗試...
2025-09-28 16:26:03 - [WARNING] - [512280345618546699] Key #0 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.23 秒後進行第 3 次嘗試...
2025-09-28 16:26:05 - [ERROR] - [512280345618546699] Key #0 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:26:05 - [WARNING] - [512280345618546699] Key #1 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.17 秒後進行第 2 次嘗試...
2025-09-28 16:26:06 - [WARNING] - [512280345618546699] Key #1 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.36 秒後進行第 3 次嘗試...
2025-09-28 16:26:09 - [ERROR] - [512280345618546699] Key #1 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:26:09 - [WARNING] - [512280345618546699] Key #2 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 1.29 秒後進行第 2 次嘗試...
2025-09-28 16:26:11 - [WARNING] - [512280345618546699] Key #2 (模型: HammerAI/llama-3-lexi-uncensored:latest) 遭遇臨時性 API 錯誤 (InvalidArgument)。將在 2.46 秒後進行第 3 次嘗試...
2025-09-28 16:26:13 - [ERROR] - [512280345618546699] Key #2 (模型: HammerAI/llama-3-lexi-uncensored:latest) 在 3 次內部重試後仍然失敗 (InvalidArgument)。將輪換到下一個金鑰並觸發持久化冷卻。
2025-09-28 16:26:13 - [ERROR] - [512280345618546699] [Final Failure] 所有模型和金鑰均最終失敗。最後的錯誤是: 400 * GenerateContentRequest.model: unexpected model name format

2025-09-28 16:26:13 - [ERROR] - 處理使用者 512280345618546699 的「純粹生成」流程時發生異常: 400 * GenerateContentRequest.model: unexpected model name format
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1507, in on_message
    final_response = await ai_instance.preprocess_and_generate(input_data)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 2868, in preprocess_and_generate
    structured_rag_context = await self.retrieve_and_summarize_memories(user_input, relevant_characters, relevant_characters)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4981, in retrieve_and_summarize_memories
    fact_sheet = await self.ainvoke_with_rotation(local_prompt, output_schema=RagFactSheet, models_to_try_override=[self.ollama_model_name])
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 836, in ainvoke_with_rotation
    raise last_exception if last_exception else Exception("ainvoke_with_rotation failed without a specific exception.")
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 753, in ainvoke_with_rotation
    response = await asyncio.wait_for(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\asyncio\tasks.py", line 445, in wait_for
    return fut.result()
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\generativeai\generative_models.py", line 385, in generate_content_async
    response = await self._async_client.generate_content(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\ai\generativelanguage_v1beta\services\generative_service\async_client.py", line 440, in generate_content
    response = await rpc(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\api_core\retry\retry_unary_async.py", line 231, in retry_wrapped_func
    return await retry_target(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\api_core\retry\retry_unary_async.py", line 163, in retry_target
    next_sleep = _retry_error_helper(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\api_core\retry\retry_base.py", line 214, in _retry_error_helper
    raise final_exc from source_exc
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\api_core\retry\retry_unary_async.py", line 158, in retry_target
    return await target()
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\google\api_core\grpc_helpers_async.py", line 88, in __await__
    raise exceptions.from_grpc_error(rpc_error) from rpc_error
google.api_core.exceptions.InvalidArgument: 400 * GenerateContentRequest.model: unexpected model name format

2025-09-28 16:31:15 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-09-28 16:31:15 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-09-28 16:31:15 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-09-28 16:31:15 - [INFO] - Discord Bot is ready!
2025-09-28 16:31:18 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-09-28 16:31:18 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-09-28 16:31:19 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-09-28 16:31:27 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 126 條文檔到 RAG 語料庫。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] (Retriever Builder) 已成功從持久化檔案構建 RAG 檢索器。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 所有構建鏈的前置資源已準備就緒。
2025-09-28 16:31:27 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 1 條訊息。
2025-09-28 16:31:27 - [INFO] - [512280345618546699] 啟動「純粹生成」對話流程...
2025-09-28 16:31:27 - [INFO] - [512280345618546699] [純粹生成流程] 正在準備上下文...
2025-09-28 16:31:27 - [INFO] - [512280345618546699] [指令實體提取] 通過 LORE 字典找到實體: {'米婭'}
2025-09-28 16:31:29 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-09-28 16:31:29 - [INFO] - [512280345618546699] [上下文篩選 in 'local' mode] 核心目標: ['米婭'], 背景角色: []
2025-09-28 16:31:29 - [INFO] - [512280345618546699] [RAG查詢強化] 查詢已擴展為: '描述米婭在宅邸散步遇到維利爾斯勛爵 Mia 蒙恩者 活神蹟 聖女 母畜 米婭'
2025-09-28 16:31:29 - [INFO] - [512280345618546699] [RAG事實提取-1] 嘗試使用雲端模型處理原始文本...
2025-09-28 16:31:29 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 16:31:29 - [WARNING] - [512280345618546699] [RAG事實提取-1] 雲端模型審查了原始文本。降級到層級 2 (雲端+代碼化)...
2025-09-28 16:31:30 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-09-28 16:31:30 - [ERROR] - [512280345618546699] [RAG事實提取-2] 🔥 代碼化備援失敗: Prompt blocked due to PROHIBITED_CONTENT
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4973, in retrieve_and_summarize_memories
    fact_sheet = await self.ainvoke_with_rotation(full_prompt, output_schema=RagFactSheet, retry_strategy='none')
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4981, in retrieve_and_summarize_memories
    fact_sheet = await self.ainvoke_with_rotation(full_prompt, output_schema=RagFactSheet, retry_strategy='none')
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 791, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 762, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to PROHIBITED_CONTENT
2025-09-28 16:31:30 - [WARNING] - [512280345618546699] [RAG事實提取] 所有雲端策略均失敗。降級到層級 3 (本地模型)...
2025-09-28 16:31:30 - [INFO] - [512280345618546699] [RAG事實提取-3] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 進行事實提取...
2025-09-28 16:33:49 - [ERROR] - [512280345618546699] [RAG事實提取-3] 呼叫本地模型進行事實提取時發生未知錯誤: 12 validation errors for RagFactSheet
involved_characters.0
  Input should be a valid string [type=string_type, input_value={'name': '米婭', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.1
  Input should be a valid string [type=string_type, input_value={'name': '莉莉絲', 'de...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.2
  Input should be a valid string [type=string_type, input_value={'name': '絲月', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.3
  Input should be a valid string [type=string_type, input_value={'name': '卡萊兒', 'de...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.4
  Input should be a valid string [type=string_type, input_value={'name': '莉娜', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.5
  Input should be a valid string [type=string_type, input_value={'name': '安娜', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.0
  Input should be a valid string [type=string_type, input_value={'name': '維利爾斯家...邸', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.1
  Input should be a valid string [type=string_type, input_value={'name': '貧民窟', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.2
  Input should be a valid string [type=string_type, input_value={'name': '聖露修道院', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.0
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...聖女與活神蹟。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.1
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...澤的完美容器。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.2
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...誕下聖女米婭。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 4773, in _invoke_local_ollama_summarizer
    validated_result = RagFactSheet.model_validate(parsed_json)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
pydantic_core._pydantic_core.ValidationError: 12 validation errors for RagFactSheet
involved_characters.0
  Input should be a valid string [type=string_type, input_value={'name': '米婭', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.1
  Input should be a valid string [type=string_type, input_value={'name': '莉莉絲', 'de...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.2
  Input should be a valid string [type=string_type, input_value={'name': '絲月', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.3
  Input should be a valid string [type=string_type, input_value={'name': '卡萊兒', 'de...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.4
  Input should be a valid string [type=string_type, input_value={'name': '莉娜', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
involved_characters.5
  Input should be a valid string [type=string_type, input_value={'name': '安娜', 'descr...性', 'race': '人類'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.0
  Input should be a valid string [type=string_type, input_value={'name': '維利爾斯家...邸', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.1
  Input should be a valid string [type=string_type, input_value={'name': '貧民窟', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
key_locations.2
  Input should be a valid string [type=string_type, input_value={'name': '聖露修道院', 'description': ''}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.0
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...聖女與活神蹟。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.1
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...澤的完美容器。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
core_events.2
  Input should be a valid string [type=string_type, input_value={'event_name': '', 'descr...誕下聖女米婭。'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-09-28 16:33:49 - [ERROR] - [512280345618546699] [RAG事實提取-4] 所有提取層級均失敗！
2025-09-28 16:33:49 - [INFO] - [512280345618546699] [AI導演] 正在啟動導演決策模組...
2025-09-28 16:33:51 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-09-28 16:33:51 - [INFO] - [512280345618546699] [AI導演] 決策完成。最終劇本大綱: '米婭在埃德蒙王國王都的「咆哮壁爐酒館」平民區的昏暗光線中，空氣中混雜著廉價麥酒、煙燻木材和汗水的味道。她正在酒館中觀察著工匠、學徒和小市民們的互動，傾聽著他們關於貧民窟那位能創造奇蹟的「生命之神」的傳聞，這些傳聞正被不斷扭曲、放大，成為酒客們熱衷的談資。突然，她被一個聲音打斷了，是卡爾•維利爾斯勳爵。他帶著一抹玩味的笑容，目光在米婭身上遊移，似乎對她出現在這樣一個地方感到些許意外，又似乎早已預料到。勳爵開口，聲音帶著他特有的、令人難以捉摸的磁性，他問米婭為何會出現在這裡，語氣中帶著一絲不容置疑的權威，但同時也隱藏著一絲探究的意味。米婭需要回應勳爵的詢問，同時要保持她聖女和蒙恩者的身份，並對勳爵的出現做出反應。請描寫米婭的反應以及她與勳爵的對話，展現出兩人之間微妙的權力關係和各自的立場。'
2025-09-28 16:33:51 - [INFO] - [512280345618546699] [純粹生成流程] 正在執行小說生成...
2025-09-28 16:34:30 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #4.
2025-09-28 16:34:31 - [INFO] - [512280345618546699] [純粹生成流程] 小說文本生成成功，並已為事後分析創建詳細上下文快照。
2025-09-28 16:34:31 - [INFO] - [512280345618546699] 回應已發送。正在啟動統一的「事後分析」任務...
2025-09-28 16:34:33 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析任務...
2025-09-28 16:34:35 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #5.
2025-09-28 16:34:35 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #5) 遭遇解析或驗證錯誤: ValidationError。
2025-09-28 16:34:35 - [ERROR] - [512280345618546699] [事後分析] 任務主體發生未預期的異常: 3 validation errors for PostGenerationAnalysisResult
lore_updates.0.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_npc...是為了勳爵。'}]}}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
lore_updates.1.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_npc...眾人的注意。'}]}}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
lore_updates.2.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_wor...婭的行為相關。'}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1355, in _background_lore_extraction
    analysis_result = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 802, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 783, in ainvoke_with_rotation
    return output_schema.model_validate(json.loads(clean_json_str))
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
pydantic_core._pydantic_core.ValidationError: 3 validation errors for PostGenerationAnalysisResult
lore_updates.0.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_npc...是為了勳爵。'}]}}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
lore_updates.1.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_npc...眾人的注意。'}]}}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
lore_updates.2.tool_name
  Field required [type=missing, input_value={'tool_code': 'update_wor...婭的行為相關。'}}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
2025-09-28 16:34:55 - [INFO] - [512280345618546699] [撤銷] 已成功從場景 '512280345618546699_local_埃德蒙王國_王都_咆哮壁爐酒館' 的短期記憶中撤銷上一回合。
2025-09-28 16:34:55 - [INFO] - [512280345618546699] [撤銷-後端] 正在嘗試從資料庫刪除最新一條長期記憶...
2025-09-28 16:34:56 - [INFO] - [512280345618546699] [撤銷-後端] ✅ 成功刪除 ID 為 1 的長期記憶。
2025-09-28 16:34:56 - [INFO] - [512280345618546699] [撤銷] 處於DM頻道，跳過刪除使用者訊息的步驟。
