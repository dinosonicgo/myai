### AI Lover Log - Last updated at 2025-10-03T16:49:16.859892 ###

2025-10-03 15:53:58 - [INFO] - [512280345618546699] 處於設定流程中，即使資料庫無記錄，也創建一個臨時的記憶體實例。
2025-10-03 15:53:58 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-03 15:53:58 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-03 15:53:58 - [INFO] - [512280345618546699] 正在創建本地 Embedding 模型 'infgrad/stella-base-zh-v2' 實例...
2025-10-03 15:54:02 - [INFO] - [512280345618546699] ✅ 本地 Embedding 模型實例創建成功。
2025-10-03 15:54:02 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-03 15:54:02 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['world_settings']
2025-10-03 15:54:02 - [WARNING] - [512280345618546699] 在持久化更新時找不到使用者資料，將創建新記錄。
2025-10-03 15:54:02 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 15:54:04 - [INFO] - [512280345618546699] (UI Event) Persistent 'ContinueToUserSetupView' button clicked.
2025-10-03 15:54:14 - [INFO] - [512280345618546699] (UI Event) CharacterSettingsModal submitted for profile_type: 'user', is_setup_flow: True
2025-10-03 15:54:14 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile']
2025-10-03 15:54:14 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 15:54:15 - [INFO] - [512280345618546699] (UI Event) Persistent 'ContinueToAiSetupView' button clicked.
2025-10-03 15:54:25 - [INFO] - [512280345618546699] (UI Event) CharacterSettingsModal submitted for profile_type: 'ai', is_setup_flow: True
2025-10-03 15:54:26 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['ai_profile']
2025-10-03 15:54:26 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 15:54:27 - [INFO] - [512280345618546699] [創世流程] 檔案上傳開始，已設定 active_setups 狀態鎖。
2025-10-03 15:54:37 - [INFO] - [512280345618546699] (on_message) 偵測到用戶處於活躍的創世流程中，已忽略常規訊息 '...' 以防止競爭。
2025-10-03 15:54:39 - [INFO] - [512280345618546699] [創世流程 v64.0] Graph 驅動的流程已啟動。
2025-10-03 15:54:39 - [INFO] - [512280345618546699] [後台創世] 正在將世界聖經原文分割成文檔...
2025-10-03 15:54:39 - [INFO] - [512280345618546699] [後台創世] 正在觸發 RAG 索引創始構建...
2025-10-03 15:54:39 - [INFO] - [512280345618546699] (Retriever Builder) 進入外部文檔注入模式，將使用 34 條傳入文檔構建純向量索引...
2025-10-03 15:55:18 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 純向量檢索器已成功從外部文檔構建。
2025-10-03 15:55:18 - [INFO] - [512280345618546699] [後台創世] RAG 索引構建完成，準備執行創世圖...
2025-10-03 15:55:18 - [INFO] - [512280345618546699] (Setup Graph|1/4) Node: process_canon -> 節點已啟動。
2025-10-03 15:55:18 - [INFO] - [512280345618546699] (Setup Graph|1/4) 檢測到世界聖經文本 (長度: 27258)，開始處理...
2025-10-03 15:55:18 - [INFO] - [512280345618546699] [數據入口-軌道B] 正在啟動 LORE 解析管線...
2025-10-03 15:55:18 - [INFO] - [512280345618546699] [LORE 解析] 已將世界聖經原文分割成 8 個文本塊進行處理。
2025-10-03 15:55:18 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 1/8...
2025-10-03 15:55:18 - [INFO] - [512280345618546699] [LORE 解析 1-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:55:33 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-03 15:55:33 - [INFO] - [512280345618546699] [LORE 解析 1-1/5] ✅ 成功！
2025-10-03 15:55:33 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 2/8...
2025-10-03 15:55:33 - [INFO] - [512280345618546699] [LORE 解析 2-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:55:54 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #1.
2025-10-03 15:55:54 - [INFO] - [512280345618546699] [LORE 解析 2-1/5] ✅ 成功！
2025-10-03 15:55:54 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 3/8...
2025-10-03 15:55:54 - [INFO] - [512280345618546699] [LORE 解析 3-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:56:07 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #2.
2025-10-03 15:56:07 - [INFO] - [512280345618546699] [LORE 解析 3-1/5] ✅ 成功！
2025-10-03 15:56:07 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 4/8...
2025-10-03 15:56:07 - [INFO] - [512280345618546699] [LORE 解析 4-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:56:26 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-10-03 15:56:26 - [INFO] - [512280345618546699] [LORE 解析 4-1/5] ✅ 成功！
2025-10-03 15:56:26 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 5/8...
2025-10-03 15:56:26 - [INFO] - [512280345618546699] [LORE 解析 5-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:56:41 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #4.
2025-10-03 15:56:41 - [INFO] - [512280345618546699] [LORE 解析 5-1/5] ✅ 成功！
2025-10-03 15:56:41 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 6/8...
2025-10-03 15:56:41 - [INFO] - [512280345618546699] [LORE 解析 6-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:56:59 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #5.
2025-10-03 15:56:59 - [INFO] - [512280345618546699] [LORE 解析 6-1/5] ✅ 成功！
2025-10-03 15:56:59 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 7/8...
2025-10-03 15:56:59 - [INFO] - [512280345618546699] [LORE 解析 7-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:57:14 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-03 15:57:14 - [INFO] - [512280345618546699] [LORE 解析 7-1/5] ✅ 成功！
2025-10-03 15:57:14 - [INFO] - [512280345618546699] [LORE 解析] 正在處理文本塊 8/8...
2025-10-03 15:57:14 - [INFO] - [512280345618546699] [LORE 解析 8-1/5] 正在嘗試【理想方案：雲端宏觀解析】...
2025-10-03 15:57:19 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #1.
2025-10-03 15:57:19 - [INFO] - [512280345618546699] [LORE 解析 8-1/5] ✅ 成功！
2025-10-03 15:57:19 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'npc_profile' 類別處理 130 個實體...
2025-10-03 15:59:08 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #2.
2025-10-03 15:59:15 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'location_info' 類別處理 37 個實體...
2025-10-03 15:59:19 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'item_info' 類別處理 9 個實體...
2025-10-03 15:59:20 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'creature_info' 類別處理 2 個實體...
2025-10-03 15:59:20 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'quest' 類別處理 5 個實體...
2025-10-03 15:59:20 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'world_lore' 類別處理 74 個實體...
2025-10-03 15:59:27 - [INFO] - [512280345618546699] [數據入口-軌道B] ✅ 快速解析完成，粗略版 LORE 已存入 SQL 資料庫。
2025-10-03 15:59:27 - [INFO] - [512280345618546699] (Setup Graph|1/4) LORE 智能解析完成。
2025-10-03 15:59:27 - [INFO] - [512280345618546699] (Setup Graph|2/4) Node: complete_profiles_node -> 節點已啟動，準備補完角色檔案...
2025-10-03 15:59:30 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #4.
2025-10-03 15:59:30 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-10-03 15:59:30 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile', 'ai_profile']
2025-10-03 15:59:30 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 15:59:30 - [INFO] - [512280345618546699] (Setup Graph|2/4) Node: complete_profiles_node -> 節點執行成功。
2025-10-03 15:59:30 - [INFO] - [512280345618546699] (Setup Graph|3/4) Node: world_genesis -> 節點已啟動...
2025-10-03 15:59:33 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #5.
2025-10-03 15:59:33 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-10-03 15:59:33 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 15:59:33 - [INFO] - [512280345618546699] [/start] 初始地點 '王國 > 王都 > 維利爾斯莊園 > 莊園領地邊緣的古老森林' 已成功生成並存入LORE。
2025-10-03 15:59:33 - [INFO] - [512280345618546699] (Setup Graph|3/4) Node: world_genesis -> 節點執行成功。
2025-10-03 15:59:33 - [INFO] - [512280345618546699] (Setup Graph|4/4) Node: generate_opening_scene -> 節點已啟動...
2025-10-03 15:59:33 - [INFO] - [512280345618546699] [/start] 正在使用 RAG 智能選擇開場場景...
2025-10-03 15:59:33 - [INFO] - --- [RAG 透明度日誌 Step 1/4] 初步檢索到 20 條文檔 ---
2025-10-03 15:59:33 - [INFO] - --- [RAG 透明度日誌 Step 2/4] 去重已禁用，使用全部 20 條原始文檔 ---
2025-10-03 15:59:33 - [INFO] - [512280345618546699] [RAG原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-03 15:59:33 - [INFO] - --- [RAG 透明度日誌 Step 4/4] 最終輸出 ---
2025-10-03 15:59:33 - [INFO] -   [最終 rules_context 長度]: 20
2025-10-03 15:59:33 - [INFO] -   [最終 summary_context 長度]: 19014
2025-10-03 15:59:33 - [INFO] - --- RAG 流程結束 ---
2025-10-03 15:59:33 - [INFO] - [512280345618546699] [API Key Cooling] 跳過冷卻中的 API Key #0 (針對模型 gemini-2.5-pro，剩餘 23504 秒)。
2025-10-03 16:00:06 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #1.
2025-10-03 16:00:06 - [INFO] - [512280345618546699] (Setup Graph|4/4) Node: generate_opening_scene -> 節點執行成功。
2025-10-03 16:00:07 - [INFO] - [512280345618546699] [後台創世] 正在向使用者私訊發送最終開場白...
2025-10-03 16:00:07 - [INFO] - [512280345618546699] [後台創世] 開場白發送完畢。
2025-10-03 16:00:07 - [INFO] - [512280345618546699] 後台創世流程結束，狀態鎖已釋放。
2025-10-03 16:09:38 - [INFO] - [512280345618546699] 啟動 Graph-based 對話流程...
2025-10-03 16:09:38 - [INFO] - [512280345618546699] (Graph|1) Node: perceive_scene -> 正在感知场景与恢复上下文...
2025-10-03 16:09:39 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #2.
2025-10-03 16:09:39 - [INFO] - [512280345618546699] (Graph|1) LLM 感知成功。推斷出的目標地點: ['宅邸']
2025-10-03 16:09:39 - [INFO] - [512280345618546699] (Graph|1) 檢測到遠程描述指令，導演視角從 'local' 切換到 'remote'。目標: ['宅邸']
2025-10-03 16:09:39 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-10-03 16:09:41 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-03 16:09:41 - [INFO] - [512280345618546699] (Graph|2) Node: retrieve_and_query -> 正在檢索記憶與查詢LORE...
2025-10-03 16:09:42 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-10-03 16:09:42 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #3) 遭遇解析或驗證錯誤: OutputParserException。
2025-10-03 16:09:42 - [WARNING] - [512280345618546699] (Graph|2) 源頭清洗失敗，將使用原始輸入進行查詢。
2025-10-03 16:09:42 - [INFO] - --- [RAG 透明度日誌 Step 1/4] 初步檢索到 20 條文檔 ---
2025-10-03 16:09:42 - [INFO] - --- [RAG 透明度日誌 Step 2/4] 去重已禁用，使用全部 20 條原始文檔 ---
2025-10-03 16:09:42 - [INFO] - [512280345618546699] [RAG原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-03 16:09:42 - [INFO] - --- [RAG 透明度日誌 Step 4/4] 最終輸出 ---
2025-10-03 16:09:42 - [INFO] -   [最終 rules_context 長度]: 20
2025-10-03 16:09:42 - [INFO] -   [最終 summary_context 長度]: 18944
2025-10-03 16:09:42 - [INFO] - --- RAG 流程結束 ---
2025-10-03 16:09:42 - [INFO] - [512280345618546699] [LORE 查詢] 正在從查詢 '描述米婭在宅邸遇到勳爵...' 中分析並提取實體...
2025-10-03 16:09:42 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-03 16:09:43 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #4.
2025-10-03 16:09:43 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勳爵']
2025-10-03 16:09:43 - [INFO] - [512280345618546699] [LORE 查詢] 已識別出實體: ['米婭', '勳爵', '宅邸']，正在從資料庫檢索...
2025-10-03 16:09:43 - [INFO] - [512280345618546699] [LORE 查詢] 查詢完畢，共找到 5 條相關 LORE。
2025-10-03 16:09:43 - [INFO] - [512280345618546699] (Graph|2) 查詢完成。檢索到 5 條相關LORE。
2025-10-03 16:09:43 - [INFO] - [512280345618546699] (Graph|3) Node: expansion_decision_and_execution -> 正在決策是否擴展LORE...
2025-10-03 16:09:43 - [ERROR] - 處理使用者 512280345618546699 的 Graph 流程時發生異常: 'AILover' object has no attribute 'get_expansion_decision_chain'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1368, in on_message
    final_state = await self.bot.main_graph.ainvoke(initial_state)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 3088, in ainvoke
    async for chunk in self.astream(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 2926, in astream
    async for _ in runner.atick(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_runner.py", line 295, in atick
    await arun_with_retry(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_retry.py", line 137, in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 693, in ainvoke
    input = await step.ainvoke(input, config, **kwargs)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 457, in ainvoke
    ret = await self.afunc(*args, **kwargs)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\graph.py", line 199, in expansion_decision_and_execution_node
    decision_chain_prompt = ai_core.get_expansion_decision_chain()
AttributeError: 'AILover' object has no attribute 'get_expansion_decision_chain'
2025-10-03 16:33:06 - [INFO] - 正在編譯主對話圖 (main_graph)...
2025-10-03 16:33:06 - [INFO] - ✅ 主對話圖編譯成功。
2025-10-03 16:33:06 - [INFO] - 正在編譯創世流程圖 (setup_graph)...
2025-10-03 16:33:06 - [INFO] - ✅ 創世流程圖編譯成功。
2025-10-03 16:33:06 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-10-03 16:33:06 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-10-03 16:33:07 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-10-03 16:33:07 - [INFO] - Discord Bot is ready!
2025-10-03 16:33:10 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-10-03 16:33:10 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-03 16:33:10 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-03 16:35:27 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-03 16:35:27 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-03 16:35:27 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-03 16:35:27 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-03 16:35:27 - [INFO] - [512280345618546699] 正在創建本地 Embedding 模型 'infgrad/stella-base-zh-v2' 實例...
2025-10-03 16:35:31 - [INFO] - [512280345618546699] ✅ 本地 Embedding 模型實例創建成功。
2025-10-03 16:35:32 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-03 16:35:32 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-03 16:35:32 - [WARNING] - [512280345618546699] (Retriever Builder) BM25 持久化檔案不存在或加載失敗，將從 ChromaDB 中恢復 BM25 專用語料庫。
2025-10-03 16:35:32 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-03 16:35:32 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-03 16:35:32 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 1 條訊息。
2025-10-03 16:35:32 - [INFO] - [512280345618546699] 啟動 Graph-based 對話流程...
2025-10-03 16:35:32 - [INFO] - [512280345618546699] (Graph|1) Node: perceive_scene -> 正在感知场景与恢复上下文...
2025-10-03 16:35:33 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-03 16:35:33 - [INFO] - [512280345618546699] (Graph|1) LLM 感知成功。推斷出的目標地點: ['宅邸']
2025-10-03 16:35:33 - [INFO] - [512280345618546699] (Graph|1) 未檢測到本地切換信號，導演視角保持為 'remote'。
2025-10-03 16:35:33 - [INFO] - [512280345618546699] (Graph|2) Node: retrieve_and_query -> 正在檢索記憶與查詢LORE...
2025-10-03 16:35:34 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #1.
2025-10-03 16:35:34 - [ERROR] - [512280345618546699] 在 ainvoke 期間發生未知錯誤 (模型: gemini-2.5-flash-lite): 'dict' object has no attribute 'model_validate'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 964, in ainvoke_with_rotation
    return output_schema.model_validate(json.loads(repaired_str))
AttributeError: 'dict' object has no attribute 'model_validate'
2025-10-03 16:35:34 - [WARNING] - [512280345618546699] (Graph|2) 源頭清洗失敗，將使用原始輸入進行查詢。
2025-10-03 16:35:35 - [INFO] - --- [RAG 透明度日誌 Step 1/4] 初步檢索到 21 條文檔 ---
2025-10-03 16:35:35 - [INFO] - --- [RAG 透明度日誌 Step 2/4] 去重已禁用，使用全部 21 條原始文檔 ---
2025-10-03 16:35:35 - [INFO] - [512280345618546699] [RAG原文直通] ✅ 成功拼接全部 21 條原始文檔作為 summary_context。
2025-10-03 16:35:35 - [INFO] - --- [RAG 透明度日誌 Step 4/4] 最終輸出 ---
2025-10-03 16:35:35 - [INFO] -   [最終 rules_context 長度]: 20
2025-10-03 16:35:35 - [INFO] -   [最終 summary_context 長度]: 19977
2025-10-03 16:35:35 - [INFO] - --- RAG 流程結束 ---
2025-10-03 16:35:35 - [INFO] - [512280345618546699] [LORE 查詢] 正在從查詢 '描述米婭在宅邸遇到勳爵...' 中分析並提取實體...
2025-10-03 16:35:35 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-03 16:35:36 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #2.
2025-10-03 16:35:36 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勳爵']
2025-10-03 16:35:36 - [INFO] - [512280345618546699] [LORE 查詢] 已識別出實體: ['宅邸', '勳爵', '米婭']，正在從資料庫檢索...
2025-10-03 16:35:36 - [INFO] - [512280345618546699] [LORE 查詢] 查詢完畢，共找到 5 條相關 LORE。
2025-10-03 16:35:36 - [INFO] - [512280345618546699] (Graph|2) 查詢完成。檢索到 5 條相關LORE。
2025-10-03 16:35:36 - [INFO] - [512280345618546699] (Graph|3) Node: expansion_decision_and_execution -> 正在決策是否擴展LORE...
2025-10-03 16:35:37 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-10-03 16:35:37 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #3) 遭遇解析或驗證錯誤: JSONDecodeError。
2025-10-03 16:35:37 - [ERROR] - 處理使用者 512280345618546699 的 Graph 流程時發生異常: Expecting ',' delimiter: line 3 column 24 (char 51)
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1368, in on_message
    final_state = await self.bot.main_graph.ainvoke(initial_state)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 3088, in ainvoke
    async for chunk in self.astream(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 2926, in astream
    async for _ in runner.atick(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_runner.py", line 295, in atick
    await arun_with_retry(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_retry.py", line 137, in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 693, in ainvoke
    input = await step.ainvoke(input, config, **kwargs)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 457, in ainvoke
    ret = await self.afunc(*args, **kwargs)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\graph.py", line 205, in expansion_decision_and_execution_node
    decision = await ai_core.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 985, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 964, in ainvoke_with_rotation
    return output_schema.model_validate(json.loads(repaired_str))
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\__init__.py", line 346, in loads
    return _default_decoder.decode(s)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\decoder.py", line 337, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\decoder.py", line 353, in raw_decode
    obj, end = self.scan_once(s, idx)
json.decoder.JSONDecodeError: Expecting ',' delimiter: line 3 column 24 (char 51)
2025-10-03 16:43:57 - [INFO] - 正在編譯主對話圖 (main_graph)...
2025-10-03 16:43:57 - [INFO] - ✅ 主對話圖編譯成功。
2025-10-03 16:43:57 - [INFO] - 正在編譯創世流程圖 (setup_graph)...
2025-10-03 16:43:57 - [INFO] - ✅ 創世流程圖編譯成功。
2025-10-03 16:43:57 - [INFO] - 所有持久化 UI 視圖已成功註冊。
2025-10-03 16:43:57 - [INFO] - 正在嘗試將應用程式指令 (Slash Commands) 全域同步到 Discord...
2025-10-03 16:43:58 - [INFO] - ✅ 應用程式指令全域同步成功！(注意：全域指令更新可能需要長達一小時才能在所有伺服器生效)
2025-10-03 16:43:58 - [INFO] - Discord Bot is ready!
2025-10-03 16:44:00 - [INFO] - 【健康檢查 & Keep-Alive】背景任務已啟動。
2025-10-03 16:44:00 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-03 16:44:01 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-03 16:44:09 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-03 16:44:09 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-03 16:44:09 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-03 16:44:09 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-03 16:44:09 - [INFO] - [512280345618546699] 正在創建本地 Embedding 模型 'infgrad/stella-base-zh-v2' 實例...
2025-10-03 16:44:13 - [INFO] - [512280345618546699] ✅ 本地 Embedding 模型實例創建成功。
2025-10-03 16:44:13 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-03 16:44:13 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-03 16:44:13 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 34 條文檔到 RAG 語料庫。
2025-10-03 16:44:13 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-03 16:44:13 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-03 16:44:13 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 1 條訊息。
2025-10-03 16:44:13 - [INFO] - [512280345618546699] 啟動 Graph-based 對話流程...
2025-10-03 16:44:13 - [INFO] - [512280345618546699] (Graph|1) Node: perceive_scene -> 正在感知场景与恢复上下文...
2025-10-03 16:44:14 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-03 16:44:14 - [INFO] - [512280345618546699] (Graph|1) LLM 感知成功。推斷出的目標地點: ['宅邸']
2025-10-03 16:44:14 - [INFO] - [512280345618546699] (Graph|1) 未檢測到本地切換信號，導演視角保持為 'remote'。
2025-10-03 16:44:14 - [INFO] - [512280345618546699] (Graph|2) Node: retrieve_and_query -> 正在檢索記憶與查詢LORE...
2025-10-03 16:44:15 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #1.
2025-10-03 16:44:17 - [INFO] - --- [RAG 透明度日誌 Step 1/4] 初步檢索到 22 條文檔 ---
2025-10-03 16:44:17 - [INFO] - --- [RAG 透明度日誌 Step 2/4] 去重已禁用，使用全部 22 條原始文檔 ---
2025-10-03 16:44:17 - [INFO] - [512280345618546699] [RAG原文直通] ✅ 成功拼接全部 22 條原始文檔作為 summary_context。
2025-10-03 16:44:17 - [INFO] - --- [RAG 透明度日誌 Step 4/4] 最終輸出 ---
2025-10-03 16:44:17 - [INFO] -   [最終 rules_context 長度]: 20
2025-10-03 16:44:17 - [INFO] -   [最終 summary_context 長度]: 20903
2025-10-03 16:44:17 - [INFO] - --- RAG 流程結束 ---
2025-10-03 16:44:17 - [INFO] - [512280345618546699] [LORE 查詢] 正在從查詢 '這段手稿片段描繪了角色米婭初次抵達一處宏偉宅邸，並在此與其主人，一位勳爵，進行了一次關鍵性的會面。此...' 中分析並提取實體...
2025-10-03 16:44:17 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-03 16:44:18 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #2.
2025-10-03 16:44:18 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勳爵']
2025-10-03 16:44:18 - [INFO] - [512280345618546699] [LORE 查詢] 已識別出實體: ['米婭', '宅邸', '勳爵']，正在從資料庫檢索...
2025-10-03 16:44:18 - [INFO] - [512280345618546699] [LORE 查詢] 查詢完畢，共找到 5 條相關 LORE。
2025-10-03 16:44:18 - [INFO] - [512280345618546699] (Graph|2) 查詢完成。檢索到 5 條相關LORE。
2025-10-03 16:44:18 - [INFO] - [512280345618546699] (Graph|3) Node: expansion_decision_and_execution -> 正在決策是否擴展LORE...
2025-10-03 16:44:18 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #3.
2025-10-03 16:44:18 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #3) 遭遇解析或驗證錯誤: JSONDecodeError。
2025-10-03 16:44:18 - [ERROR] - 處理使用者 512280345618546699 的 Graph 流程時發生異常: Expecting ',' delimiter: line 3 column 24 (char 51)
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 1368, in on_message
    final_state = await self.bot.main_graph.ainvoke(initial_state)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 3088, in ainvoke
    async for chunk in self.astream(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\main.py", line 2926, in astream
    async for _ in runner.atick(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_runner.py", line 295, in atick
    await arun_with_retry(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\pregel\_retry.py", line 137, in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 693, in ainvoke
    input = await step.ainvoke(input, config, **kwargs)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\langgraph\_internal\_runnable.py", line 457, in ainvoke
    ret = await self.afunc(*args, **kwargs)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\graph.py", line 220, in expansion_decision_and_execution_node
    decision = await ai_core.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 982, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 960, in ainvoke_with_rotation
    return output_schema.model_validate(json.loads(repaired_str))
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\__init__.py", line 346, in loads
    return _default_decoder.decode(s)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\decoder.py", line 337, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\json\decoder.py", line 353, in raw_decode
    obj, end = self.scan_once(s, idx)
json.decoder.JSONDecodeError: Expecting ',' delimiter: line 3 column 24 (char 51)
