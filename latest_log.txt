### AI Lover Log - Last updated at 2025-10-07T00:47:00.113024 ###

2025-10-06 23:57:50 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-06 23:57:50 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-06 23:57:50 - [INFO] - 正在全域同步應用程式指令...
2025-10-06 23:57:50 - [INFO] - ✅ 指令已全域同步！
2025-10-06 23:57:50 - [INFO] - Discord Bot setup hook finished!
2025-10-06 23:57:53 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-06 23:57:54 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-06 23:58:08 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-06 23:58:08 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-06 23:58:08 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-06 23:58:08 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-06 23:58:08 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-06 23:58:10 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-06 23:58:10 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-06 23:58:10 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-06 23:58:10 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 2 條文檔到 RAG 語料庫。
2025-10-06 23:58:10 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-06 23:58:10 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-06 23:58:10 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 7 條訊息。
2025-10-06 23:58:11 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-06 23:58:11 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-06 23:58:11 - [INFO] - [512280345618546699] [前置 LORE-1/4] 正在識別新實體...
2025-10-06 23:58:12 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-06 23:58:12 - [INFO] - [512280345618546699] [前置 LORE-1/4備援] 使用 spaCy NER + 字典匹配进行实体识别...
2025-10-06 23:58:12 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['米婭', '勛爵']
2025-10-06 23:58:13 - [INFO] - [512280345618546699] [前置 LORE] 無需創建或更新 LORE。
2025-10-06 23:58:13 - [INFO] - [512280345618546699] [主生成] 開始執行對話生成...
2025-10-06 23:58:14 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['爵從', '拱形', '米婭', '泛起', '這正', '將積蓄', '握著', '勛爵', '米婭纖細', '聖女']
2025-10-06 23:58:14 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-06 23:58:15 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-06 23:58:15 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '勛爵']
2025-10-06 23:58:15 - [INFO] - [512280345618546699] [主生成] 查詢擴展完成，最終核心實體: ['DINO', '米婭纖細', '將積蓄', '爵從', '拱形', '米婭', '這正', '泛起', '握著', '勛爵', '聖女', '碧']
2025-10-06 23:58:15 - [INFO] - [512280345618546699] [RAG 原文直通] 正在使用查询: '米婭是母畜，會立刻起身用口舌為勛爵清潔肉棒 DINO 米婭纖細 將積蓄 爵從 拱形 米婭 這正 泛起 握著 勛爵 聖女 碧'
2025-10-06 23:58:16 - [INFO] - [512280345618546699] [RAG 原文直通] 檢索成功，獲得 17 份候選文檔。
2025-10-06 23:58:16 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 17 條原始文檔作為 summary_context。
2025-10-06 23:58:17 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-06 23:58:19 - [ERROR] - [512280345618546699] 在 ainvoke 期間發生未知錯誤 (模型: gemini-2.5-pro): 'int' object has no attribute 'name'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1673, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
AttributeError: 'int' object has no attribute 'name'
2025-10-06 23:58:19 - [ERROR] - 處理使用者 512280345618546699 的 RAG 直通流程時發生異常: 'int' object has no attribute 'name'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\cogs\core_cog.py", line 1303, in on_message
    final_response = await ai_instance.direct_rag_generate(user_input)
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 631, in direct_rag_generate
    final_response = await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1792, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1673, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {response.prompt_feedback.block_reason.name}")
AttributeError: 'int' object has no attribute 'name'
2025-10-07 00:01:12 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-07 00:01:15 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-07 00:01:15 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-07 00:01:15 - [INFO] - 正在全域同步應用程式指令...
2025-10-07 00:01:15 - [INFO] - ✅ 指令已全域同步！
2025-10-07 00:01:15 - [INFO] - Discord Bot setup hook finished!
2025-10-07 00:01:18 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-07 00:01:19 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-07 00:01:20 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-07 00:01:20 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-07 00:01:20 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-07 00:01:20 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-07 00:01:20 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-07 00:01:23 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-07 00:01:23 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-07 00:01:23 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-07 00:01:23 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 2 條文檔到 RAG 語料庫。
2025-10-07 00:01:23 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-07 00:01:23 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-07 00:01:23 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 7 條訊息。
2025-10-07 00:01:23 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-07 00:01:23 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-07 00:01:23 - [INFO] - [512280345618546699] [前置 LORE-1/4] 正在識別新實體...
2025-10-07 00:01:24 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:01:24 - [INFO] - [512280345618546699] [前置 LORE-1/4備援] 使用 spaCy NER + 字典匹配进行实体识别...
2025-10-07 00:01:25 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['勛爵', '米婭']
2025-10-07 00:01:25 - [INFO] - [512280345618546699] [前置 LORE] 無需創建或更新 LORE。
2025-10-07 00:01:25 - [INFO] - [512280345618546699] [主生成] 開始執行對話生成...
2025-10-07 00:01:26 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['爵從', '握著', '拱形', '米婭纖細', '勛爵', '這正', '將積蓄', '泛起', '聖女', '米婭']
2025-10-07 00:01:26 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-07 00:01:27 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:01:27 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '勛爵']
2025-10-07 00:01:27 - [INFO] - [512280345618546699] [主生成] 查詢擴展完成，最終核心實體: ['DINO', '米婭纖細', '將積蓄', '爵從', '握著', '拱形', '勛爵', '這正', '泛起', '聖女', '米婭', '碧']
2025-10-07 00:01:27 - [INFO] - [512280345618546699] [RAG 原文直通] 正在使用查询: '米婭是母畜，會立刻起身用口舌為勛爵清潔肉棒 DINO 米婭纖細 將積蓄 爵從 握著 拱形 勛爵 這正 泛起 聖女 米婭 碧'
2025-10-07 00:01:28 - [INFO] - [512280345618546699] [RAG 原文直通] 檢索成功，獲得 17 份候選文檔。
2025-10-07 00:01:28 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 17 條原始文檔作為 summary_context。
2025-10-07 00:01:30 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:01:31 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:01:31 - [WARNING] - [512280345618546699] 遭遇審查 (Prompt blocked due to 4)。啟動【最高指令集注入 & 強制 Key 輪換重試】策略...
2025-10-07 00:01:31 - [INFO] - [512280345618546699] [強制重試] 已準備 3 個備用 API Keys 進行重試。
2025-10-07 00:01:31 - [INFO] - [512280345618546699] [強制重試 1/3] 使用 API Key #0 進行嘗試...
2025-10-07 00:01:33 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:01:33 - [WARNING] - [512280345618546699] [強制重試 1/3] 使用 Key #0 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:01:33 - [INFO] -    -> 將在 0.5 秒後使用下一個 Key 進行嘗試...
2025-10-07 00:01:34 - [INFO] - [512280345618546699] [強制重試 2/3] 使用 API Key #1 進行嘗試...
2025-10-07 00:01:36 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:01:36 - [WARNING] - [512280345618546699] [強制重試 2/3] 使用 Key #1 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:01:36 - [INFO] -    -> 將在 1.0 秒後使用下一個 Key 進行嘗試...
2025-10-07 00:01:37 - [INFO] - [512280345618546699] [強制重試 3/3] 使用 API Key #2 進行嘗試...
2025-10-07 00:01:39 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:01:39 - [WARNING] - [512280345618546699] [強制重試 3/3] 使用 Key #2 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:01:39 - [ERROR] - [512280345618546699] 【強制 Key 輪換重試】策略在 3 次嘗試後最終失敗。
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1680, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 3306, in _force_and_retry
    return await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1736, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1680, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4
2025-10-07 00:01:39 - [CRITICAL] - [512280345618546699] [Direct RAG] 核心生成链在所有策略之後最終失敗！
2025-10-07 00:01:40 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-07 00:01:41 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [事後分析] 本次分析未檢測到需要更新或創建的 LORE。
2025-10-07 00:01:43 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
2025-10-07 00:14:35 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-07 00:14:38 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-07 00:14:38 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-07 00:14:38 - [INFO] - 正在全域同步應用程式指令...
2025-10-07 00:14:39 - [INFO] - ✅ 指令已全域同步！
2025-10-07 00:14:39 - [INFO] - Discord Bot setup hook finished!
2025-10-07 00:14:41 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-07 00:14:42 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-07 00:14:54 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-07 00:14:54 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-07 00:14:54 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-07 00:14:54 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-07 00:14:54 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-07 00:14:56 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-07 00:14:56 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-07 00:14:56 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-07 00:14:56 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 2 條文檔到 RAG 語料庫。
2025-10-07 00:14:56 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-07 00:14:56 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-07 00:14:56 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 9 條訊息。
2025-10-07 00:14:57 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-07 00:14:57 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-07 00:14:57 - [INFO] - [512280345618546699] [前置 LORE-1/4] 正在識別新實體...
2025-10-07 00:14:58 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:14:58 - [INFO] - [512280345618546699] [前置 LORE-1/4備援] 使用 spaCy NER + 字典匹配进行实体识别...
2025-10-07 00:14:59 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['勛爵', '米婭']
2025-10-07 00:14:59 - [INFO] - [512280345618546699] [前置 LORE] 無需創建或更新 LORE。
2025-10-07 00:14:59 - [INFO] - [512280345618546699] [主生成] 開始執行對話生成...
2025-10-07 00:15:00 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['勛爵', '米婭']
2025-10-07 00:15:00 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-07 00:15:01 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:15:01 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '勛爵']
2025-10-07 00:15:01 - [INFO] - [512280345618546699] [主生成] 查詢擴展完成，最終核心實體: ['DINO', '勛爵', '米婭', '碧']
2025-10-07 00:15:01 - [INFO] - [512280345618546699] [RAG 原文直通] 正在使用查询: '米婭是母畜，會立刻起身用口舌為勛爵清潔肉棒 DINO 勛爵 米婭 碧'
2025-10-07 00:15:02 - [INFO] - [512280345618546699] [RAG 原文直通] 檢索成功，獲得 17 份候選文檔。
2025-10-07 00:15:02 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 17 條原始文檔作為 summary_context。
2025-10-07 00:15:02 - [INFO] - [512280345618546699] [History Summarizer] 嘗試主路徑：隔離編碼摘要...
2025-10-07 00:15:03 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:15:03 - [INFO] - [512280345618546699] [History Summarizer] ✅ 主路徑成功。
2025-10-07 00:15:05 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:15:05 - [WARNING] - [512280345618546699] 遭遇審查 (Prompt blocked due to 4)。啟動【最高指令集注入 & 強制 Key 輪換重試】策略...
2025-10-07 00:15:05 - [INFO] - [512280345618546699] [強制重試] 已準備 3 個備用 API Keys 進行重試。
2025-10-07 00:15:05 - [INFO] - [512280345618546699] [強制重試 1/3] 使用 API Key #0 進行嘗試...
2025-10-07 00:15:07 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:15:07 - [WARNING] - [512280345618546699] [強制重試 1/3] 使用 Key #0 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:15:07 - [INFO] -    -> 將在 0.5 秒後使用下一個 Key 進行嘗試...
2025-10-07 00:15:08 - [INFO] - [512280345618546699] [強制重試 2/3] 使用 API Key #1 進行嘗試...
2025-10-07 00:15:10 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:15:10 - [WARNING] - [512280345618546699] [強制重試 2/3] 使用 Key #1 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:15:10 - [INFO] -    -> 將在 1.0 秒後使用下一個 Key 進行嘗試...
2025-10-07 00:15:11 - [INFO] - [512280345618546699] [強制重試 3/3] 使用 API Key #2 進行嘗試...
2025-10-07 00:15:13 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-07 00:15:13 - [WARNING] - [512280345618546699] [強制重試 3/3] 使用 Key #2 的嘗試失敗: Prompt blocked due to 4
2025-10-07 00:15:13 - [ERROR] - [512280345618546699] 【強制 Key 輪換重試】策略在 3 次嘗試後最終失敗。
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1794, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 3420, in _force_and_retry
    return await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1850, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1794, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4
2025-10-07 00:15:13 - [CRITICAL] - [512280345618546699] [Direct RAG] 核心生成链在所有策略之後最終失敗！
2025-10-07 00:15:14 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-07 00:15:15 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-07 00:15:16 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:15:16 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-10-07 00:15:17 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-10-07 00:15:17 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-10-07 00:15:19 - [INFO] - [512280345618546699] 背景任務：檢測到 2 條 LORE 更新，準備執行...
2025-10-07 00:15:19 - [INFO] - --- [512280345618546699] (LORE Executor) 開始串行執行 2 個修正後的LORE任务 ---
2025-10-07 00:15:19 - [INFO] - [512280345618546699] [RAG增量更新] 已成功 更新 LORE '宅邸 > 米婭' 到 RAG 索引。當前總文檔數: 2
2025-10-07 00:15:19 - [INFO] - [512280345618546699] [RAG增量更新] 已成功 更新 LORE '宅邸 > 勛爵' 到 RAG 索引。當前總文檔數: 2
2025-10-07 00:15:19 - [INFO] - --- [512280345618546699] (LORE Executor) LORE 扩展計畫执行完毕 ---
2025-10-07 00:15:19 - [INFO] - [512280345618546699] 背景任務：LORE更新執行完畢。摘要: 任務成功: 已成功更新 NPC '米婭' 的檔案。
任務成功: 已成功更新 NPC '勛爵' 的檔案。
2025-10-07 00:15:19 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
2025-10-07 00:28:48 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-07 00:28:52 - [ERROR] - 🔥 核心 Cog 加載失敗: Extension 'src.cogs.core_cog' raised an error: NameError: name 'Union' is not defined
Traceback (most recent call last):
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\discord\ext\commands\bot.py", line 935, in _load_from_module_spec
    spec.loader.exec_module(lib)  # type: ignore
  File "<frozen importlib._bootstrap_external>", line 883, in exec_module
  File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\cogs\core_cog.py", line 28, in <module>
    from ..ai_core import AILover, GENERATION_MODEL_PRIORITY
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 100, in <module>
    class AILover:
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1588, in AILover
    prompt_or_messages: Union[str, List[Dict[str, Any]]], # <--- 核心改动：接受字符串或消息列表
NameError: name 'Union' is not defined

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\discord_bot.py", line 41, in setup_hook
    await self.load_extension("src.cogs.core_cog")
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\discord\ext\commands\bot.py", line 1013, in load_extension
    await self._load_from_module_spec(spec, name)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\discord\ext\commands\bot.py", line 938, in _load_from_module_spec
    raise errors.ExtensionFailed(key, e) from e
discord.ext.commands.errors.ExtensionFailed: Extension 'src.cogs.core_cog' raised an error: NameError: name 'Union' is not defined
2025-10-07 00:35:57 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-07 00:36:01 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-07 00:36:01 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-07 00:36:01 - [INFO] - 正在全域同步應用程式指令...
2025-10-07 00:36:01 - [INFO] - ✅ 指令已全域同步！
2025-10-07 00:36:01 - [INFO] - Discord Bot setup hook finished!
2025-10-07 00:36:04 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-07 00:36:05 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-07 00:39:11 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-07 00:39:11 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-07 00:39:11 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-07 00:39:11 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-07 00:39:11 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-07 00:39:13 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-07 00:39:13 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-07 00:39:13 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-07 00:39:14 - [INFO] - [512280345618546699] [RAG持久化] 成功從磁碟加載了 2 條文檔到 RAG 語料庫。
2025-10-07 00:39:14 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-07 00:39:14 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-07 00:39:14 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 11 條訊息。
2025-10-07 00:39:14 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-07 00:39:14 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-07 00:39:14 - [INFO] - [512280345618546699] [前置 LORE-1/5] 正在進行意圖分類...
2025-10-07 00:39:15 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:39:16 - [INFO] - [512280345618546699] [前置 LORE-2/5] 正在執行意圖驅動的場景選角...
2025-10-07 00:39:17 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:39:18 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:39:18 - [INFO] - [512280345618546699] [前置 LORE] 無需創建或更新 LORE。
2025-10-07 00:39:18 - [INFO] - [512280345618546699] [主生成] 開始構建結構化的消息列表...
2025-10-07 00:39:18 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: ['勛爵', '米婭']
2025-10-07 00:39:19 - [INFO] - [512280345618546699] [RAG 原文直通] 正在使用查询: '米婭是母畜，會立刻起身用口舌為勛爵清潔肉棒 勛爵 碧 米婭 DINO'
2025-10-07 00:39:20 - [INFO] - [512280345618546699] [RAG 原文直通] 檢索成功，獲得 17 份候選文檔。
2025-10-07 00:39:20 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 17 條原始文檔作為 summary_context。
2025-10-07 00:39:20 - [INFO] - [512280345618546699] [History Summarizer] 嘗試主路徑：文學化摘要...
2025-10-07 00:39:21 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:39:21 - [INFO] - [512280345618546699] [History Summarizer] ✅ 主路徑成功。
2025-10-07 00:39:54 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-07 00:39:56 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-07 00:39:57 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-07 00:39:59 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:39:59 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-10-07 00:39:59 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-10-07 00:39:59 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-10-07 00:40:01 - [INFO] - [512280345618546699] 背景任務：檢測到 2 條 LORE 更新，準備執行...
2025-10-07 00:40:01 - [INFO] - --- [512280345618546699] (LORE Executor) 開始串行執行 2 個修正後的LORE任务 ---
2025-10-07 00:40:01 - [WARNING] - [512280345618546699] [抗幻覺] 檢測到對不存在實體 '米婭' 的更新。啟動事實查核...
2025-10-07 00:40:02 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:40:02 - [INFO] - [512280345618546699] [抗幻覺] 事實查核裁定為 CREATE。正在創建新的 LORE...
2025-10-07 00:40:02 - [WARNING] - [512280345618546699] [抗幻覺] 檢測到對不存在實體 '勛爵' 的更新。啟動事實查核...
2025-10-07 00:40:03 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-07 00:40:03 - [INFO] - [512280345618546699] [抗幻覺] 事實查核裁定為 MERGE。正在合併到 '宅邸 > 勛爵'...
2025-10-07 00:40:04 - [INFO] - --- [512280345618546699] (LORE Executor) LORE 扩展計畫执行完毕 ---
2025-10-07 00:40:04 - [INFO] - [512280345618546699] 背景任務：LORE更新執行完畢。摘要: 任務成功 (修正後創建): 已為新實體 '米婭' 創建檔案。
任務成功 (修正後合併): 已將信息合併到 '宅邸 > 勛爵'。
2025-10-07 00:40:04 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
2025-10-07 00:46:45 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-07 00:46:49 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-07 00:46:49 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-07 00:46:49 - [INFO] - 正在全域同步應用程式指令...
2025-10-07 00:46:49 - [INFO] - ✅ 指令已全域同步！
2025-10-07 00:46:49 - [INFO] - Discord Bot setup hook finished!
2025-10-07 00:46:52 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-07 00:46:53 - [INFO] - 已成功發送啟動成功通知給管理員。
