### AI Lover Log - Last updated at 2025-10-05T21:35:44.491759 ###

2025-10-05 17:30:47 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [後台創世-原生] 角色檔案補完成功。
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [後台創世-原生] 步驟 2/2: 正在生成開場白...
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [/start] 正在使用 RAG 智能選擇並創作開場場景...
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [实体名称提取 (v2.2)] 正在从查询 '根據這個世界的核心設定(這是一個魔法的幻想世界。)以及主角 DINO 和 碧 的背景，為他們的故事尋...' 中分析实体...
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [RAG 原文直通] 查詢已擴展為: '的背景，為他們的故事尋找一個最富有戲劇性、最符合世界觀的、適合二人出場的、遠離權力中心的靜態初始場景或情境。 根據這個世界的核心設定(這是一個魔法的幻想世界。)以及主角 DINO 和 碧'
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [RAG 原文直通] 粗略檢索成功，獲得 20 份候選文檔。
2025-10-05 17:30:47 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-05 17:31:13 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-05 17:31:13 - [INFO] - [512280345618546699] [/start] 開場白已生成，正在從中反向提取權威地點...
2025-10-05 17:31:14 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 17:31:14 - [INFO] - [512280345618546699] [/start] ✅ 地點提取成功: 研究室。正在更新 GameState...
2025-10-05 17:31:14 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-10-05 17:31:14 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 17:31:14 - [INFO] - [512280345618546699] [後台創世-原生] 開場白生成成功。
2025-10-05 17:31:15 - [INFO] - [512280345618546699] [後台創世] 正在向使用者私訊發送最終開場白...
2025-10-05 17:31:15 - [INFO] - [512280345618546699] [後台創世] 開場白發送完畢。
2025-10-05 17:31:15 - [INFO] - [512280345618546699] 後台創世流程結束，狀態鎖已釋放。
2025-10-05 17:33:42 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-05 17:33:42 - [INFO] - [512280345618546699] [Direct RAG] 啟動 LORE 優先的 RAG 直通生成流程...
2025-10-05 17:33:42 - [INFO] - [512280345618546699] [LORE 擴展] 正在檢查是否需要擴展 LORE...
2025-10-05 17:33:44 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 17:33:44 - [INFO] - [512280345618546699] [LORE 擴展] ✅ 檢測到新實體骨架，啟動【資訊回填】流程...
2025-10-05 17:33:44 - [INFO] - [512280345618546699] [LORE 回填-L1] 正在為 '米婭' 嘗試雲端精煉...
2025-10-05 17:33:44 - [WARNING] - [512280345618546699] [LORE 回填-L1] 雲端精煉失敗 (AttributeError)。降級至 L2 (本地模型)。
2025-10-05 17:33:44 - [ERROR] - [512280345618546699] [LORE 擴展] 在前置 LORE 擴展管線中發生錯誤: local variable 'rag_context' referenced before assignment
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 497, in direct_rag_generate
    {"aliases": rag_context, "description": rag_context, "appearance": rag_context, "skills": rag_context, "relationships": rag_context}
UnboundLocalError: local variable 'rag_context' referenced before assignment
2025-10-05 17:33:44 - [INFO] - [512280345618546699] [查詢擴展] 正在整合短期記憶以感知場景上下文...
2025-10-05 17:33:44 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: {'研究室', '拱形窗', '略顯', '地毯', '這片屬於學者', '墨水與'}
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勛爵']
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [查詢擴展] 檢測到為本地場景，正在將主角添加至核心實體列表。
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [查詢擴展] 場景感知完成，最終核心實體: ['這片屬於學者', 'DINO', '研究室', '拱形窗', '墨水與', '宅邸', '略顯', '米婭', '地毯', '勛爵', '碧']
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [实体名称提取 (v2.2)] 正在从查询 '描述米婭在宅邸遇到勛爵 這片屬於學者 DINO 研究室 拱形窗 墨水與 宅邸 略顯 米婭 地毯 勛爵...' 中分析实体...
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [RAG 原文直通] 查詢已擴展為: '描述米婭在宅邸遇到勛爵 這片屬於學者 DINO 研究室 拱形窗 墨水與 宅邸 略顯 米婭 地毯 勛爵 碧'
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [RAG 原文直通] 粗略檢索成功，獲得 20 份候選文檔。
2025-10-05 17:33:45 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-05 17:33:46 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 17:33:48 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-05 17:33:48 - [WARNING] - [512280345618546699] 最終生成鏈遭遇審查 (Prompt blocked due to 4)。啟動【最高指令集注入 & 強制 Key 輪換重試】策略...
2025-10-05 17:33:48 - [INFO] - [512280345618546699] [強制重試] 已準備 3 個備用 API Keys 進行重試。
2025-10-05 17:33:48 - [INFO] - [512280345618546699] [強制重試 1/3] 使用 API Key #0 進行嘗試...
2025-10-05 17:33:50 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-05 17:33:50 - [WARNING] - [512280345618546699] [強制重試 1/3] 使用 Key #0 的嘗試失敗: Prompt blocked due to 4
2025-10-05 17:33:50 - [INFO] -    -> 將在 0.5 秒後使用下一個 Key 進行嘗試...
2025-10-05 17:33:51 - [INFO] - [512280345618546699] [強制重試 2/3] 使用 API Key #1 進行嘗試...
2025-10-05 17:33:53 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #1) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-05 17:33:53 - [WARNING] - [512280345618546699] [強制重試 2/3] 使用 Key #1 的嘗試失敗: Prompt blocked due to 4
2025-10-05 17:33:53 - [INFO] -    -> 將在 1.0 秒後使用下一個 Key 進行嘗試...
2025-10-05 17:33:54 - [INFO] - [512280345618546699] [強制重試 3/3] 使用 API Key #2 進行嘗試...
2025-10-05 17:33:56 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-pro' (Key #2) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-05 17:33:56 - [WARNING] - [512280345618546699] [強制重試 3/3] 使用 Key #2 的嘗試失敗: Prompt blocked due to 4
2025-10-05 17:33:56 - [ERROR] - [512280345618546699] 【強制 Key 輪換重試】策略在 3 次嘗試後最終失敗。
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1468, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 3123, in _force_and_retry
    return await self.ainvoke_with_rotation(
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1522, in ainvoke_with_rotation
    raise e
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 1468, in ainvoke_with_rotation
    raise BlockedPromptException(f"Prompt blocked due to {reason_str}")
google.generativeai.types.generation_types.BlockedPromptException: Prompt blocked due to 4
2025-10-05 17:33:56 - [CRITICAL] - [512280345618546699] [Direct RAG] 核心生成链在所有策略之後最終失敗！
2025-10-05 17:33:56 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-05 17:33:58 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-05 17:34:00 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 17:34:00 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-10-05 17:34:00 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-10-05 17:34:00 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-10-05 17:34:02 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
2025-10-05 18:32:32 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-05 18:32:35 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-05 18:32:35 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-05 18:32:35 - [INFO] - 正在全域同步應用程式指令...
2025-10-05 18:32:36 - [INFO] - ✅ 指令已全域同步！
2025-10-05 18:32:36 - [INFO] - Discord Bot setup hook finished!
2025-10-05 18:32:38 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-05 18:32:39 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-05 18:35:46 - [INFO] - [512280345618546699] [Admin Command] 手動觸發強制更新與重啟流程...
2025-10-05 18:35:46 - [INFO] - [512280345618546699] [Admin Command] 已獲取 Git 鎖，開始執行同步...
2025-10-05 18:35:51 - [INFO] - [512280345618546699] [Admin Command] Git 鎖已釋放。
2025-10-05 18:38:13 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-05 18:38:16 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-05 18:38:16 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-05 18:38:16 - [INFO] - 正在全域同步應用程式指令...
2025-10-05 18:38:17 - [INFO] - ✅ 指令已全域同步！
2025-10-05 18:38:17 - [INFO] - Discord Bot setup hook finished!
2025-10-05 18:38:19 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-05 18:38:20 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-05 18:47:35 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-05 18:47:35 - [INFO] - 為使用者 512280345618546699 成功創建並初始化 AI 實例。
2025-10-05 18:47:35 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-05 18:47:35 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-05 18:47:35 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-05 18:47:37 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-05 18:47:37 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-05 18:47:37 - [INFO] - [512280345618546699] (Retriever Builder) 檢測到現有 RAG 索引，正在加載...
2025-10-05 18:47:37 - [WARNING] - [512280345618546699] (Retriever Builder) BM25 持久化檔案不存在或加載失敗，將從 ChromaDB 中恢復 BM25 專用語料庫。
2025-10-05 18:47:37 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 混合檢索器已成功從持久化索引加載。
2025-10-05 18:47:37 - [INFO] - [512280345618546699] 正在從資料庫恢復短期場景記憶...
2025-10-05 18:47:37 - [INFO] - [512280345618546699] 成功恢復了 1 個場景的對話歷史，總計 3 條訊息。
2025-10-05 18:47:38 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-05 18:47:38 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-05 18:47:38 - [INFO] - [512280345618546699] [LORE 擴展] 正在檢查是否需要擴展 LORE...
2025-10-05 18:47:39 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 18:47:40 - [INFO] - [512280345618546699] [LORE 擴展] ✅ 檢測到新實體骨架，啟動【資訊回填】流程...
2025-10-05 18:47:40 - [INFO] - [512280345618546699] [LORE 回填] 正在為新 NPC '米婭' 檢索背景資訊...
2025-10-05 18:47:40 - [WARNING] - [512280345618546699] [LORE 回填-L1] 雲端精煉失敗 (AttributeError)。降級至 L2 (本地模型)。
2025-10-05 18:47:40 - [ERROR] - [512280345618546699] [LORE 擴展] 在前置 LORE 擴展管線中发生严重错误，但主生成流程将继续: 'AILover' object has no attribute '_raw_rag_retrieval'
Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 500, in direct_rag_generate
    rag_context = await self._raw_rag_retrieval(rag_query)
AttributeError: 'AILover' object has no attribute '_raw_rag_retrieval'
2025-10-05 18:47:40 - [INFO] - [512280345618546699] [查詢擴展] 正在整合短期記憶以感知場景上下文...
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: {'地毯', '墨水與', '研究室', '略顯', '拱形窗', '這片屬於學者'}
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勛爵']
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [查詢擴展] 檢測到為本地場景，正在將主角添加至核心實體列表。
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [查詢擴展] 場景感知完成，最終核心實體: ['這片屬於學者', 'DINO', '墨水與', '研究室', '拱形窗', '勛爵', '宅邸', '地毯', '略顯', '米婭', '碧']
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [实体名称提取 (v2.2)] 正在从查询 '描述米婭在宅邸遇到勛爵 這片屬於學者 DINO 墨水與 研究室 拱形窗 勛爵 宅邸 地毯 略顯 米婭...' 中分析实体...
2025-10-05 18:47:41 - [INFO] - [512280345618546699] [RAG 原文直通] 查詢已擴展為: '描述米婭在宅邸遇到勛爵 這片屬於學者 DINO 墨水與 研究室 拱形窗 勛爵 宅邸 地毯 略顯 米婭 碧'
2025-10-05 18:47:42 - [INFO] - [512280345618546699] [RAG 原文直通] 粗略檢索成功，獲得 23 份候選文檔。
2025-10-05 18:47:42 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 23 條原始文檔作為 summary_context。
2025-10-05 18:47:43 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 18:48:19 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-05 18:48:20 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-05 18:48:21 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-05 18:48:24 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 18:48:24 - [INFO] - [512280345618546699] [長期記憶寫入] 正在保存預生成的安全摘要...
2025-10-05 18:48:24 - [INFO] - [512280345618546699] [長期記憶寫入] 互動記錄已成功保存到 SQL 資料庫。
2025-10-05 18:48:24 - [INFO] - [512280345618546699] [長期記憶寫入] 安全摘要保存完畢。
2025-10-05 18:48:24 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
2025-10-05 19:38:33 - [INFO] - [512280345618546699] [Admin Command] 手動觸發強制更新與重啟流程...
2025-10-05 19:38:33 - [INFO] - [512280345618546699] [Admin Command] 已獲取 Git 鎖，開始執行同步...
2025-10-05 19:38:38 - [INFO] - [512280345618546699] [Admin Command] Git 鎖已釋放。
2025-10-05 19:44:07 - [INFO] - 正在加載核心 Cog (core_cog)...
2025-10-05 19:44:10 - [INFO] - ✅ 核心 Cog (core_cog) 已加載，並且所有持久化視圖已成功註冊。
2025-10-05 19:44:10 - [INFO] - ✅ 核心 Cog 加載成功。
2025-10-05 19:44:10 - [INFO] - 正在全域同步應用程式指令...
2025-10-05 19:44:11 - [INFO] - ✅ 指令已全域同步！
2025-10-05 19:44:11 - [INFO] - Discord Bot setup hook finished!
2025-10-05 19:44:13 - [INFO] - Logged in as AI#4450 (ID: 1358417100250808531)
2025-10-05 19:44:14 - [INFO] - 已成功發送啟動成功通知給管理員。
2025-10-05 20:29:32 - [INFO] - [512280345618546699] [Data Reset] 正在啟動使用者資料重置流程...
2025-10-05 20:29:32 - [INFO] - [512280345618546699] [Data Reset] 所有相關的資料庫記錄已成功刪除。
2025-10-05 20:29:32 - [INFO] - [512280345618546699] [Data Reset] 向量儲存目錄 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\data\vector_stores\512280345618546699' 已成功刪除。
2025-10-05 20:29:32 - [INFO] - [512280345618546699] [Data Reset] 資料重置流程已全部完成。
2025-10-05 20:29:34 - [INFO] - [512280345618546699] (UI Event) Persistent 'StartSetupView' button clicked.
2025-10-05 20:29:39 - [INFO] - 使用者 512280345618546699 沒有活躍的 AI 實例，嘗試創建...
2025-10-05 20:29:39 - [INFO] - [512280345618546699] 處於設定流程中，即使資料庫無記錄，也創建一個臨時的記憶體實例。
2025-10-05 20:29:39 - [INFO] - [512280345618546699] 核心數據模板 'world_snapshot_template.txt' 已成功加載。
2025-10-05 20:29:39 - [INFO] - [512280345618546699] 核心協議 '00_supreme_directive.txt' 已成功加載。
2025-10-05 20:29:39 - [INFO] - ✅ [Embedding Loader] 檢測到本地模型路徑，正在嘗試從 'D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\models\stella-base-zh-v2' 加載...
2025-10-05 20:29:41 - [INFO] - ✅ [Embedding Loader] 本地 Embedding 模型實例創建成功。
2025-10-05 20:29:41 - [INFO] - [512280345618546699] 所有輕量級前置資源已準備就緒 (RAG 創建已延遲)。
2025-10-05 20:29:41 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['world_settings']
2025-10-05 20:29:41 - [WARNING] - [512280345618546699] 在持久化更新時找不到使用者資料，將創建新記錄。
2025-10-05 20:29:41 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 20:29:43 - [INFO] - [512280345618546699] (UI Event) Persistent 'ContinueToUserSetupView' button clicked.
2025-10-05 20:29:54 - [INFO] - [512280345618546699] (UI Event) CharacterSettingsModal submitted for profile_type: 'user', is_setup_flow: True
2025-10-05 20:29:55 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile']
2025-10-05 20:29:55 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 20:29:56 - [INFO] - [512280345618546699] (UI Event) Persistent 'ContinueToAiSetupView' button clicked.
2025-10-05 20:30:09 - [INFO] - [512280345618546699] (UI Event) CharacterSettingsModal submitted for profile_type: 'ai', is_setup_flow: True
2025-10-05 20:30:09 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['ai_profile']
2025-10-05 20:30:09 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 20:30:11 - [INFO] - [512280345618546699] [創世流程] 檔案上傳開始，已設定 active_setups 狀態鎖。
2025-10-05 20:30:19 - [INFO] - [512280345618546699] (on_message) 偵測到用戶處於活躍的創世流程中，已忽略常規訊息 '...' 以防止競爭。
2025-10-05 20:30:21 - [INFO] - [512280345618546699] [創世流程 v65.1] 原生 Python 驅動的流程已啟動。
2025-10-05 20:30:21 - [INFO] - [512280345618546699] [後台創世] 正在將世界聖經原文分割成文檔...
2025-10-05 20:30:21 - [INFO] - [512280345618546699] [後台創世] 正在觸發 RAG 索引創始構建...
2025-10-05 20:30:21 - [INFO] - [512280345618546699] (Retriever Builder) 進入外部文檔注入模式，將使用 36 條傳入文檔構建純向量索引...
2025-10-05 20:31:05 - [INFO] - [512280345618546699] (Retriever Builder) ✅ 純向量檢索器已成功從外部文檔構建。
2025-10-05 20:31:05 - [INFO] - [512280345618546699] [後台創世] RAG 索引構建完成，準備執行原生創世步驟...
2025-10-05 20:31:05 - [INFO] - [512280345618546699] [後台創世-原生] 步驟 1/2: 正在補完角色檔案...
2025-10-05 20:31:08 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:31:09 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['user_profile', 'ai_profile']
2025-10-05 20:31:09 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [後台創世-原生] 角色檔案補完成功。
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [後台創世-原生] 步驟 2/2: 正在生成開場白...
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [/start] 正在使用 RAG 智能選擇並創作開場場景...
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [实体名称提取 (v2.2)] 正在从查询 '根據這個世界的核心設定(這是一個魔法的幻想世界。)以及主角 DINO 和 碧 的背景，為他們的故事尋...' 中分析实体...
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [RAG 原文直通] 查詢已擴展為: '的背景，為他們的故事尋找一個最富有戲劇性、最符合世界觀的、適合二人出場的、遠離權力中心的靜態初始場景或情境。 根據這個世界的核心設定(這是一個魔法的幻想世界。)以及主角 DINO 和 碧'
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [RAG 原文直通] 粗略檢索成功，獲得 20 份候選文檔。
2025-10-05 20:31:09 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-05 20:31:37 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-05 20:31:37 - [INFO] - [512280345618546699] [/start] 開場白已生成，正在從中反向提取權威地點...
2025-10-05 20:31:38 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:31:38 - [INFO] - [512280345618546699] [/start] ✅ 地點提取成功: 聖凱瑟琳學院 > 藏書庫。正在更新 GameState...
2025-10-05 20:31:38 - [INFO] - [512280345618546699] 接收到 profile 更新請求: ['game_state']
2025-10-05 20:31:38 - [INFO] - [512280345618546699] Profile 更新並持久化成功。
2025-10-05 20:31:38 - [INFO] - [512280345618546699] [後台創世-原生] 開場白生成成功。
2025-10-05 20:31:38 - [INFO] - [512280345618546699] [後台創世] 正在向使用者私訊發送最終開場白...
2025-10-05 20:31:39 - [INFO] - [512280345618546699] [後台創世] 開場白發送完畢。
2025-10-05 20:31:39 - [INFO] - [512280345618546699] 後台創世流程結束，狀態鎖已釋放。
2025-10-05 20:32:42 - [INFO] - [512280345618546699] 啟動 RAG 直通對話流程...
2025-10-05 20:32:42 - [INFO] - [512280345618546699] [Direct RAG] 啟动 LORE 优先的 RAG 直通生成流程...
2025-10-05 20:32:42 - [INFO] - [512280345618546699] [LORE 擴展] 正在檢查是否需要擴展 LORE...
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [LORE 擴展] ✅ 檢測到新實體骨架，啟動【資訊回填】流程...
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [LORE 回填] 正在為新 NPC '米婭' 檢索背景資訊...
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [Raw RAG] 正在為內部流程執行原始文檔檢索，查詢: '關於角色 '米婭' 的所有已知資訊、背景故事、外貌、性格和能力。'
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [Raw RAG] ✅ 成功檢索到 20 份原始文檔。
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [LORE 回填-L1] 正在為 '米婭' 嘗試雲端精煉...
2025-10-05 20:32:44 - [WARNING] - [512280345618546699] 模型 'gemini-2.5-flash-lite' (Key #0) 遭遇內容審查或安全錯誤: BlockedPromptException。
2025-10-05 20:32:44 - [WARNING] - [512280345618546699] [LORE 回填-L1] 雲端精煉遭遇審查 (Prompt blocked due to 4)。降級至 L2 (本地模型)。
2025-10-05 20:32:44 - [INFO] - [512280345618546699] [LORE精煉-L2] 正在使用本地模型 'HammerAI/llama-3-lexi-uncensored:latest' 為 '米婭' 進行精煉 (Attempt 1/2)...
2025-10-05 20:37:45 - [ERROR] - [512280345618546699] [LORE精煉-L2] 🔥 呼叫本地模型進行精煉時發生未知錯誤: 
Traceback (most recent call last):
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_transports\default.py", line 69, in map_httpcore_exceptions
    yield
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_transports\default.py", line 373, in handle_async_request
    resp = await self._pool.handle_async_request(req)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\connection_pool.py", line 256, in handle_async_request
    raise exc from None
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\connection_pool.py", line 236, in handle_async_request
    response = await connection.handle_async_request(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\connection.py", line 103, in handle_async_request
    return await self._connection.handle_async_request(request)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\http11.py", line 136, in handle_async_request
    raise exc
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\http11.py", line 106, in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\http11.py", line 177, in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_async\http11.py", line 217, in _receive_event
    data = await self._network_stream.read(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_backends\anyio.py", line 32, in read
    with map_exceptions(exc_map):
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpcore\_exceptions.py", line 14, in map_exceptions
    raise to_exc(exc) from exc
httpcore.ReadTimeout

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\DINO\SD\ComfyUI\personal_server\ai_lover_service\src\ai_core.py", line 3917, in _invoke_local_ollama_refiner
    response = await client.post("http://localhost:11434/api/generate", json=payload)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1892, in post
    return await self.request(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1574, in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1661, in send
    response = await self._send_handling_auth(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1689, in _send_handling_auth
    response = await self._send_handling_redirects(
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1726, in _send_handling_redirects
    response = await self._send_single_request(request)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1763, in _send_single_request
    response = await transport.handle_async_request(request)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_transports\default.py", line 372, in handle_async_request
    with map_httpcore_exceptions():
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\USER\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_transports\default.py", line 86, in map_httpcore_exceptions
    raise mapped_exc(message) from exc
httpx.ReadTimeout
2025-10-05 20:37:45 - [ERROR] - [512280345618546699] [LORE 回填-L3] 所有 LLM 精煉層級均失敗！為 '米婭' 觸發程式級備援，僅保存基礎骨架。
2025-10-05 20:37:45 - [INFO] - [512280345618546699] [LORE 回填] 正在為新 NPC '勛爵' 檢索背景資訊...
2025-10-05 20:37:45 - [INFO] - [512280345618546699] [Raw RAG] 正在為內部流程執行原始文檔檢索，查詢: '關於角色 '勛爵' 的所有已知資訊、背景故事、外貌、性格和能力。'
2025-10-05 20:37:45 - [INFO] - [512280345618546699] [Raw RAG] ✅ 成功檢索到 20 份原始文檔。
2025-10-05 20:37:45 - [INFO] - [512280345618546699] [LORE 回填-L1] 正在為 '勛爵' 嘗試雲端精煉...
2025-10-05 20:37:47 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:37:47 - [INFO] - [512280345618546699] [LORE 回填-L1] ✅ 雲端精煉成功。
2025-10-05 20:37:47 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'npc_profile' 類別處理 2 個實體...
2025-10-05 20:37:59 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-05 20:37:59 - [INFO] - [512280345618546699] (_resolve_and_save) 正在為 'location_info' 類別處理 1 個實體...
2025-10-05 20:37:59 - [INFO] - [512280345618546699] [LORE 擴展] 新的 LORE (包含已回填資訊) 已成功創建並存入資料庫。
2025-10-05 20:37:59 - [INFO] - [512280345618546699] [查詢擴展] 正在整合短期記憶以感知場景上下文...
2025-10-05 20:38:00 - [INFO] - [512280345618546699] [雙引擎實體提取] 成功提取高質量實體: {'這永恆', '識聖', '彩繪玻璃窗', '藏書庫'}
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [輸入分析-L1] 正在嘗試使用 LLM 進行語義分析...
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [輸入分析-L1] ✅ LLM 分析成功。提取實體: ['米婭', '宅邸', '勛爵']
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [查詢擴展] 檢測到為本地場景，正在將主角添加至核心實體列表。
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [查詢擴展] 場景感知完成，最終核心實體: ['彩繪玻璃窗', 'DINO', '這永恆', '藏書庫', '米婭', '宅邸', '勛爵', '識聖', '碧']
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [LORE 優先] 已成功注入 2 條絕對事實。
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [实体名称提取 (v2.2)] 正在从查询 '描述米婭在宅邸遇到勛爵 彩繪玻璃窗 DINO 這永恆 藏書庫 米婭 宅邸 勛爵 識聖 碧...' 中分析实体...
2025-10-05 20:38:01 - [INFO] - [512280345618546699] [RAG 原文直通] 查詢已擴展為: '描述米婭在宅邸遇到勛爵 彩繪玻璃窗 DINO 這永恆 藏書庫 米婭 宅邸 勛爵 識聖 碧'
2025-10-05 20:38:02 - [INFO] - [512280345618546699] [RAG 原文直通] 粗略檢索成功，獲得 20 份候選文檔。
2025-10-05 20:38:02 - [INFO] - [512280345618546699] [RAG 原文直通] ✅ 成功拼接全部 20 條原始文檔作為 summary_context。
2025-10-05 20:38:03 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:38:45 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-pro' with API Key #0.
2025-10-05 20:38:47 - [INFO] - [512280345618546699] RAG 直通流程執行完畢，回應已發送。事後學習任務已在背景啟動。
2025-10-05 20:38:49 - [INFO] - [512280345618546699] [事後分析] 正在啟動背景分析與分流任務...
2025-10-05 20:38:52 - [INFO] - [512280345618546699] [LLM Success] Generation successful using model 'gemini-2.5-flash-lite' with API Key #0.
2025-10-05 20:38:52 - [INFO] - [512280345618546699] [事後分析] 背景分析與分流任務完成。
